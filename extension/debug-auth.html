<!DOCTYPE html>
<html>
<head>
  <title>Extension Auth Debug</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>StarterPack Extension Auth Debug</h1>
  
  <div class="section">
    <h2>1. Extension Storage</h2>
    <button onclick="checkStorage()">Check Storage</button>
    <pre id="storage-result"></pre>
  </div>

  <div class="section">
    <h2>2. Main App Tab</h2>
    <button onclick="checkMainApp()">Check Main App</button>
    <pre id="mainapp-result"></pre>
  </div>

  <div class="section">
    <h2>3. API Test</h2>
    <button onclick="testAPI()">Test API</button>
    <pre id="api-result"></pre>
  </div>

  <div class="section">
    <h2>4. Fix Authentication</h2>
    <button onclick="openMainApp()">Open Main App to Login</button>
    <button onclick="clearAuth()">Clear All Auth Data</button>
  </div>

  <script>
    async function checkStorage() {
      const result = await chrome.storage.local.get(['authToken', 'userData', 'showWelcome']);
      document.getElementById('storage-result').textContent = JSON.stringify(result, null, 2);
    }

    async function checkMainApp() {
      try {
        const tabs = await chrome.tabs.query({ url: 'https://starter-pack-app.vercel.app/*' });
        const result = {
          tabsFound: tabs.length,
          urls: tabs.map(t => t.url)
        };
        
        if (tabs.length > 0) {
          try {
            const authData = await chrome.tabs.sendMessage(tabs[0].id, {
              action: 'getAuthFromLocalStorage'
            });
            result.authData = authData;
          } catch (e) {
            result.authError = e.message;
          }
        }
        
        document.getElementById('mainapp-result').textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('mainapp-result').textContent = 'Error: ' + error.message;
      }
    }

    async function testAPI() {
      try {
        const { authToken } = await chrome.storage.local.get('authToken');
        
        if (!authToken) {
          document.getElementById('api-result').textContent = 'No auth token found';
          return;
        }

        const response = await fetch('https://starter-pack-app.vercel.app/api/user-management', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const result = {
          status: response.status,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries())
        };

        if (response.ok) {
          result.data = await response.json();
        } else {
          result.error = await response.text();
        }

        document.getElementById('api-result').textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('api-result').textContent = 'Error: ' + error.message;
      }
    }

    function openMainApp() {
      chrome.tabs.create({ url: 'https://starter-pack-app.vercel.app/roi-finder.html' });
    }

    async function clearAuth() {
      await chrome.storage.local.clear();
      alert('All auth data cleared. Please reload the extension.');
    }
  </script>
</body>
</html>