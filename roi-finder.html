<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROI Finder - InvestorProps</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- React for components -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Load React Components -->
  <script type="text/babel" src="/components/RentalComparisonView.jsx"></script>
  <script type="text/babel" src="/components/ClientPresentationView.jsx"></script>
  
  <style>
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 auto;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    /* Form styles */
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Card styles */
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .metric-card {
      background: linear-gradient(135deg, #f3f4f6, #ffffff);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    
    /* Chart container */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }
    
    /* Colors */
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Loading Screen -->
  <div id="loading-screen" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading ROI Finder...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2" id="auth-title">Welcome Back</h1>
        <p class="text-gray-600" id="auth-subtitle">Sign in to access your property analyses</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="auth-form">
          <div class="space-y-6">
            <div id="name-field" style="display: none;">
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input type="text" id="name" class="form-input" placeholder="John Doe" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="email" class="form-input" placeholder="john@example.com" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input type="password" id="password" class="form-input" placeholder="••••••••" required minlength="6" />
            </div>

            <div id="auth-error" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm" style="display: none;"></div>

            <button type="submit" class="btn-primary w-full">
              <span id="auth-button-text">Sign In</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <p class="text-gray-600">
            <span id="auth-switch-text">Don't have an account? </span>
            <button id="auth-switch" class="text-blue-600 hover:text-blue-800 font-semibold">Sign Up</button>
          </p>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <a href="index.html" class="text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1">
            ← Back to Homepage
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-screen" class="min-h-screen bg-gray-50" style="display: none;">
    <!-- Header -->
    <div class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">InvestorProps</h1>
            <span class="text-sm text-gray-500">Dashboard</span>
          </div>
          <nav class="hidden md:flex gap-6">
            <a href="/roi-finder.html" class="text-blue-600 font-medium">Dashboard</a>
            <a href="/portfolio.html" class="text-gray-600 hover:text-gray-900">Portfolio</a>
            <a href="/reports.html" class="text-gray-600 hover:text-gray-900">Reports</a>
            <a href="/blog.html" class="text-gray-600 hover:text-gray-900">Blog</a>
            <a href="/realtor-settings.html" class="text-gray-600 hover:text-gray-900">Branding</a>
          </nav>
          <div class="flex items-center gap-4">
            <span class="text-sm text-gray-700" id="user-email"></span>
            <button id="sign-out-btn" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
          <p class="text-sm text-gray-600">Analyses Used</p>
          <p class="text-2xl font-bold text-gray-900" id="analysis-count">0 / 3</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Subscription</p>
          <p class="text-2xl font-bold text-gray-900" id="subscription-tier">Trial</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Total Analyses</p>
          <p class="text-2xl font-bold text-gray-900" id="total-analyses">0</p>
        </div>
      </div>

      <!-- New Analysis Button -->
      <div class="text-center mb-8">
        <button id="new-analysis-btn" class="btn-primary">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          New Property Analysis
        </button>
        <p class="text-xs text-gray-500 mt-2" id="debug-text">Ready to analyze properties</p>
      </div>

      <!-- Recent Analyses -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Recent Analyses</h2>
        </div>
        <div id="analyses-list" class="divide-y divide-gray-200">
          <div class="px-6 py-12 text-center text-gray-500">
            No analyses yet. Click "New Property Analysis" to get started!
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Input Form -->
  <div id="property-form-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Property ROI Analyzer</h1>
        <p class="text-gray-600">Get AI-powered investment analysis for any property worldwide</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="property-form">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
              <input type="text" id="street" class="form-input" placeholder="123 Main Street" required />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                <input type="text" id="city" class="form-input" placeholder="Toronto" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">State/Province *</label>
                <input type="text" id="state" class="form-input" placeholder="Ontario" required />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                <input type="text" id="country" class="form-input" placeholder="Canada" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Postal/Zip Code</label>
                <input type="text" id="postal" class="form-input" placeholder="M5V 3A8" />
              </div>
            </div>

            <div class="bg-blue-50 rounded-lg p-4">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="include-str-analysis" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" checked />
                <span class="text-sm text-gray-700">
                  <strong>Include Short-Term Rental (Airbnb) Analysis</strong>
                  <span class="text-xs text-gray-500 block">Compare traditional rental vs Airbnb income potential</span>
                </span>
              </label>
              <p class="text-xs text-gray-500 mt-2" id="str-trial-info">
                <!-- Trial info will be populated here -->
              </p>
            </div>

            <button type="submit" class="btn-primary w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Analyze Property
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between">
          <button id="back-to-dashboard" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
            ← Back to Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Results Screen -->
  <div id="results-screen" class="min-h-screen bg-gray-50" style="display: none;">
    <!-- Header -->
    <div class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">Property Analysis Results</h1>
          </div>
          <nav class="hidden md:flex gap-6">
            <a href="/roi-finder.html" class="text-gray-600 hover:text-gray-900">Dashboard</a>
            <a href="/portfolio.html" class="text-gray-600 hover:text-gray-900">Portfolio</a>
            <a href="/reports.html" class="text-gray-600 hover:text-gray-900">Reports</a>
            <a href="/realtor-settings.html" class="text-gray-600 hover:text-gray-900">Branding</a>
          </nav>
          <div class="flex items-center gap-4">
            <button id="back-to-dashboard-results" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              ← Back to Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Property Info -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Property Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Address</p>
              <p class="font-semibold" id="result-address">-</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Analysis Date</p>
              <p class="font-semibold" id="result-date">-</p>
            </div>
          </div>
          <div id="property-details-extra" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <!-- Extra property details will be added here -->
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="metric-card">
          <p class="text-sm text-gray-600">Market Value</p>
          <p class="text-2xl font-bold text-gray-900" id="result-value">-</p>
          <p class="text-xs text-gray-500 mt-1">Based on comparables</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-gray-600">Monthly Rent</p>
          <p class="text-2xl font-bold positive" id="result-rent">-</p>
          <p class="text-xs text-gray-500 mt-1">Market rate</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-gray-600">Cap Rate</p>
          <p class="text-2xl font-bold text-green-600" id="result-cap-rate">-</p>
          <p class="text-xs text-gray-500 mt-1">Net operating income</p>
        </div>
        <div class="metric-card">
          <p class="text-sm text-gray-600">ROI Score</p>
          <p class="text-4xl font-bold" id="result-roi-score">-</p>
          <div class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="roi-bar" class="h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- STR Comparison Section -->
      <div id="str-comparison-container" class="mb-8" style="display: none;">
        <!-- RentalComparisonView component will be mounted here -->
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Cash Flow Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="openChartDetails('cashFlow')">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Monthly Cash Flow Analysis</h3>
          <p class="text-sm text-gray-600 mb-4">Click for detailed breakdown</p>
          <div class="chart-container">
            <canvas id="cashFlowChart"></canvas>
          </div>
        </div>

        <!-- ROI Comparison Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="openChartDetails('roiComparison')">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Investment Strategy Comparison</h3>
          <p class="text-sm text-gray-600 mb-4">Click for detailed breakdown</p>
          <div class="chart-container">
            <canvas id="roiComparisonChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Detailed Analysis -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Financial Breakdown -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center" style="background-color: #f3f4f6; min-height: 60px;">
            <h3 class="text-lg font-semibold text-gray-900">Income & Expenses Breakdown</h3>
            <div class="flex gap-2" style="background-color: #e5e7eb; padding: 4px; border-radius: 8px;">
              <button id="edit-financials-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors" style="display: block !important; visibility: visible !important;">
                Edit Values
              </button>
              <button id="reset-financials-btn" class="px-3 py-1 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors" style="display: none;">
                Reset to Original
              </button>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <!-- Monthly Income -->
              <div class="bg-green-50 p-3 rounded-lg border border-green-200 mb-4">
                <h4 class="text-sm font-semibold text-green-800 mb-2">Monthly Income</h4>
                <div class="flex justify-between items-center">
                  <span class="text-gray-700">Gross Rental Income</span>
                  <div>
                    <span class="font-semibold text-green-700" id="breakdown-income">-</span>
                    <input type="number" id="edit-income" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="100" min="0">
                  </div>
                </div>
              </div>

              <!-- Monthly Expenses -->
              <div class="bg-red-50 p-3 rounded-lg border border-red-200 mb-4">
                <h4 class="text-sm font-semibold text-red-800 mb-3">Monthly Expenses</h4>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">Mortgage Payment</span>
                    <div>
                      <span class="font-semibold text-red-700" id="breakdown-mortgage">$0</span>
                      <input type="number" id="edit-mortgage" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="100" min="0" value="0">
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">Property Taxes</span>
                    <div class="flex flex-col items-end">
                      <span class="font-semibold text-red-700" id="breakdown-taxes">-</span>
                      <span class="text-xs text-gray-500" id="breakdown-taxes-annual">($0/year)</span>
                      <input type="number" id="edit-taxes" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="100" min="0" placeholder="Monthly amount">
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">Insurance</span>
                    <div class="flex flex-col items-end">
                      <span class="font-semibold text-red-700" id="breakdown-insurance">-</span>
                      <span class="text-xs text-gray-500" id="breakdown-insurance-annual">($0/year)</span>
                      <input type="number" id="edit-insurance" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="100" min="0" placeholder="Monthly amount">
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">HOA/Condo Fees</span>
                    <div>
                      <span class="font-semibold text-red-700" id="breakdown-hoa">-</span>
                      <input type="number" id="edit-hoa" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="50" min="0">
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">Maintenance</span>
                    <div class="flex flex-col items-end">
                      <span class="font-semibold text-red-700" id="breakdown-maintenance">-</span>
                      <span class="text-xs text-gray-500" id="breakdown-maintenance-annual">($0/year)</span>
                      <input type="number" id="edit-maintenance" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="100" min="0" placeholder="Annual amount">
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-700">Property Management</span>
                    <div class="flex flex-col items-end">
                      <span class="font-semibold text-red-700" id="breakdown-management">-</span>
                      <span class="text-xs text-gray-500" id="breakdown-management-rate">(8% of rent)</span>
                      <input type="number" id="edit-management" class="hidden w-24 text-right px-2 py-1 border rounded text-sm font-semibold" step="0.5" min="0" max="20" placeholder="Percentage">
                    </div>
                  </div>
                </div>
              </div>
              <div class="border-t pt-2">
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-900">Net Operating Income (Monthly)</span>
                  <span class="font-bold text-green-600" id="breakdown-net-income">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Investment Analysis -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Rental Strategy Analysis</h3>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <!-- Long-term Rental -->
              <div class="border rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-2">Long-term Rental</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">Monthly Rent:</span>
                    <span class="font-semibold ml-2" id="ltr-rent">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Annual NOI:</span>
                    <span class="font-semibold ml-2" id="ltr-noi">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Cap Rate:</span>
                    <span class="font-semibold ml-2" id="ltr-cap">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">ROI:</span>
                    <span class="font-semibold ml-2" id="ltr-roi">-</span>
                  </div>
                </div>
              </div>

              <!-- Short-term Rental -->
              <div class="border rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-2">Short-term Rental (Airbnb)</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">Daily Rate:</span>
                    <span class="font-semibold ml-2" id="str-rate">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Occupancy:</span>
                    <span class="font-semibold ml-2" id="str-occupancy">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Annual Revenue:</span>
                    <span class="font-semibold ml-2" id="str-revenue">-</span>
                  </div>
                  <div>
                    <span class="text-gray-600">ROI:</span>
                    <span class="font-semibold ml-2" id="str-roi">-</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recommendation -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
              <h4 class="font-semibold text-blue-900 mb-1">Recommendation</h4>
              <p class="text-sm text-blue-800" id="investment-recommendation">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Market Data (if available) -->
      <div id="market-data-section" class="mt-8 bg-white rounded-lg shadow" style="display: none;">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Market Analysis</h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
            <div>
              <p class="text-gray-600">Average Days on Market</p>
              <p class="font-semibold" id="days-on-market">-</p>
            </div>
            <div>
              <p class="text-gray-600">Annual Appreciation</p>
              <p class="font-semibold" id="appreciation-rate">-</p>
            </div>
            <div>
              <p class="text-gray-600">Comparable Sales</p>
              <p class="font-semibold" id="comparable-count">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Sources -->
      <div class="mt-8 bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
          <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            Data Sources & Research
          </h3>
        </div>
        <div class="p-6">
          <div class="space-y-3">
            <div id="sources-container" class="space-y-2">
              <!-- Sources will be populated dynamically -->
            </div>
            <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <p class="text-sm text-blue-800"><strong>Note:</strong> All data is researched in real-time using AI-powered market analysis and publicly available sources.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-8 flex justify-center gap-4">
        <button id="new-analysis-from-results" class="btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Analyze Another Property
        </button>
        <button id="save-analysis" class="btn-secondary">
          Save Analysis
        </button>
      </div>
    </div>
  </div>

  <!-- Chart Details Modal -->
  <div id="chart-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Chart Details</h3>
            <button onclick="closeChartDetails()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="p-6">
          <div id="modal-content">
            <!-- Content will be populated dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <script>
    console.log('Script starting...');

    // Global state
    let currentUser = null;
    let userProfile = null;
    let currentView = 'loading';
    let authMode = 'signin';
    let charts = {};
    let currentAnalysis = null;
    let originalAnalysis = null;
    let editMode = false;

    // Initialize app
    async function initApp() {
      try {
        console.log('Initializing app...');
        
        // Load Firebase config
        const response = await fetch('/api/config');
        const config = await response.json();
        console.log('Config loaded:', config);
        
        // Initialize Firebase
        firebase.initializeApp(config.firebase);
        console.log('Firebase initialized');
        
        // Set up auth listener
        firebase.auth().onAuthStateChanged(async (user) => {
          console.log('Auth state changed:', user);
          if (user) {
            currentUser = user;
            console.log('[StarterPack] User logged in:', user.email, user.uid);
            
            userProfile = await loadUserProfile(user.uid);
            console.log('[StarterPack] User profile loaded:', userProfile);
            
            // Always store auth token in localStorage for extension access
            try {
              console.log('[StarterPack] Getting ID token...');
              const token = await user.getIdToken();
              console.log('[StarterPack] Got token:', token ? 'Yes' : 'No', 'Length:', token ? token.length : 0);
              
              localStorage.setItem('starterpack_auth_token', token);
              localStorage.setItem('starterpack_user', JSON.stringify({
                uid: user.uid,
                email: user.email,
                displayName: user.displayName
              }));
              console.log('[StarterPack] Auth token stored in localStorage');
              
              // Verify storage
              const storedToken = localStorage.getItem('starterpack_auth_token');
              console.log('[StarterPack] Verified token in localStorage:', storedToken ? 'Yes' : 'No');
            } catch (error) {
              console.error('[StarterPack] Failed to store auth token:', error);
            }
            
            // Send auth token to extension if present
            const urlParams = new URLSearchParams(window.location.search);
            const fromExtension = urlParams.get('extension');
            if (fromExtension === 'true') {
              try {
                const token = await user.getIdToken();
                // Send message to extension
                if (window.opener) {
                  window.opener.postMessage({
                    type: 'AUTH_TOKEN_UPDATE',
                    token: token,
                    user: {
                      uid: user.uid,
                      email: user.email,
                      displayName: user.displayName
                    }
                  }, '*');
                }
              } catch (error) {
                console.error('Failed to send token to extension:', error);
              }
            }
            
            // Check if viewing a specific analysis
            const viewId = urlParams.get('view');
            if (viewId) {
              await loadAnalysisById(viewId);
            } else {
              showView('dashboard');
              loadUserAnalyses();
            }
          } else {
            currentUser = null;
            userProfile = null;
            showView('auth');
          }
        });
        
      } catch (error) {
        console.error('Init error:', error);
        alert('Failed to initialize app: ' + error.message);
      }
    }

    // Load user profile
    async function loadUserProfile(userId) {
      try {
        const db = firebase.firestore();
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
          return { id: doc.id, ...doc.data() };
        } else {
          // Create new profile
          const newProfile = {
            email: firebase.auth().currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscriptionStatus: 'trial',
            subscriptionTier: 'trial',
            monthlyAnalysisCount: 0,
            monthlyAnalysisLimit: 3,
            trialEndsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
          };
          
          await db.collection('users').doc(userId).set(newProfile);
          return { id: userId, ...newProfile };
        }
      } catch (error) {
        console.error('Profile load error:', error);
        return null;
      }
    }

    // Load user analyses
    async function loadUserAnalyses() {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('analyses')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .limit(10)
          .get();
        
        const analyses = [];
        snapshot.forEach(doc => {
          analyses.push({ id: doc.id, ...doc.data() });
        });
        
        // Update dashboard
        document.getElementById('total-analyses').textContent = analyses.length;
        
        // Display analyses list
        const listEl = document.getElementById('analyses-list');
        if (analyses.length > 0) {
          listEl.innerHTML = analyses.map(analysis => `
            <div class="px-6 py-4 hover:bg-gray-50 cursor-pointer" onclick="viewAnalysis('${analysis.id}')">
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-medium text-gray-900">${analysis.property_address || 'Unknown Address'}</p>
                  <p class="text-sm text-gray-500">ROI: ${analysis.roi_percentage}% • ${new Date(analysis.analysis_timestamp || analysis.createdAt?.toDate()).toLocaleDateString()}</p>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Load analyses error:', error);
      }
    }

    // View analysis
    async function viewAnalysis(analysisId) {
      try {
        const db = firebase.firestore();
        const doc = await db.collection('analyses').doc(analysisId).get();
        
        if (doc.exists) {
          const analysis = doc.data();
          displayResults(analysis);
          showView('results');
        }
      } catch (error) {
        console.error('View analysis error:', error);
        alert('Failed to load analysis');
      }
    }
    
    // Load specific analysis by property ID
    async function loadAnalysisById(propertyId) {
      try {
        const db = firebase.firestore();
        
        // Get the latest analysis for this property
        const analysisSnapshot = await db.collection('analyses')
          .where('propertyId', '==', propertyId)
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .limit(1)
          .get();
        
        if (!analysisSnapshot.empty) {
          const analysis = analysisSnapshot.docs[0].data();
          displayResults(analysis);
          showView('results');
        } else {
          console.error('No analysis found for this property');
          showView('dashboard');
        }
      } catch (error) {
        console.error('Error loading analysis:', error);
        showView('dashboard');
      }
    }

    // Show specific view
    function showView(viewName) {
      console.log('Showing view:', viewName);
      
      // Hide all screens
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-screen').style.display = 'none';
      document.getElementById('property-form-screen').style.display = 'none';
      document.getElementById('results-screen').style.display = 'none';
      
      // Show target screen
      switch(viewName) {
        case 'auth':
          document.getElementById('auth-screen').style.display = 'flex';
          updateAuthMode();
          break;
        case 'dashboard':
          document.getElementById('dashboard-screen').style.display = 'block';
          updateDashboard();
          break;
        case 'property-form':
          document.getElementById('property-form-screen').style.display = 'flex';
          updateStrTrialInfo();
          break;
        case 'results':
          document.getElementById('results-screen').style.display = 'block';
          break;
        default:
          document.getElementById('loading-screen').style.display = 'flex';
      }
      
      currentView = viewName;
    }

    // Update auth mode
    function updateAuthMode() {
      const isSignUp = authMode === 'signup';
      
      document.getElementById('auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
      document.getElementById('auth-subtitle').textContent = isSignUp 
        ? 'Start your 7-day free trial with 3 analyses'
        : 'Sign in to access your property analyses';
      document.getElementById('name-field').style.display = isSignUp ? 'block' : 'none';
      document.getElementById('auth-button-text').textContent = isSignUp ? 'Create Account' : 'Sign In';
      document.getElementById('auth-switch-text').textContent = isSignUp 
        ? 'Already have an account? ' 
        : "Don't have an account? ";
      document.getElementById('auth-switch').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    }

    // Update dashboard
    function updateDashboard() {
      if (currentUser) {
        document.getElementById('user-email').textContent = currentUser.email;
      }
      
      if (userProfile) {
        document.getElementById('analysis-count').textContent = 
          `${userProfile.monthlyAnalysisCount || 0} / ${userProfile.monthlyAnalysisLimit || 3}`;
        document.getElementById('subscription-tier').textContent = 
          (userProfile.subscriptionTier || 'Trial').charAt(0).toUpperCase() + (userProfile.subscriptionTier || 'trial').slice(1);
      }
    }

    // Update STR trial info
    function updateStrTrialInfo() {
      const infoEl = document.getElementById('str-trial-info');
      if (!userProfile) return;
      
      if (userProfile.subscriptionTier === 'pro' || userProfile.subscriptionTier === 'enterprise') {
        infoEl.innerHTML = '<span class="text-green-600">✓ STR analysis included with your Pro subscription</span>';
      } else {
        const trialsUsed = userProfile.strTrialUsed || 0;
        const trialsRemaining = Math.max(0, 5 - trialsUsed);
        
        if (trialsRemaining > 0) {
          infoEl.innerHTML = `<span class="text-blue-600">Free trial: ${trialsRemaining} STR analyses remaining</span>`;
        } else {
          infoEl.innerHTML = '<span class="text-gray-600">Free STR trial expired. <a href="#" class="text-blue-600 underline">Upgrade to Pro</a> for unlimited STR analysis</span>';
          document.getElementById('include-str-analysis').checked = false;
          document.getElementById('include-str-analysis').disabled = true;
        }
      }
    }

    // Property analysis function
    async function analyzeProperty(address) {
      try {
        console.log('Starting property analysis for:', address);
        
        // Format address
        const fullAddress = `${address.street}, ${address.city}, ${address.state}, ${address.country} ${address.postal}`.trim();
        
        // Call enhanced API with STR analysis
        const response = await fetch('/api/analyze-property-enhanced', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: currentUser.uid,
            propertyAddress: fullAddress,
            userEmail: currentUser.email,
            userName: currentUser.displayName,
            requestType: 'authenticated',
            includeStrAnalysis: document.getElementById('include-str-analysis').checked
          })
        });
        
        if (!response.ok) {
          throw new Error('Analysis API request failed');
        }
        
        const result = await response.json();
        console.log('Analysis result:', result);
        
        if (result.success && result.data) {
          return result.data;
        } else {
          throw new Error(result.error || 'Analysis failed');
        }
        
      } catch (error) {
        console.error('Analysis error:', error);
        throw error;
      }
    }

    // Display analysis results with charts
    function displayResults(analysis) {
      // Store analysis data
      currentAnalysis = JSON.parse(JSON.stringify(analysis)); // Deep copy
      originalAnalysis = JSON.parse(JSON.stringify(analysis)); // Store original for reset
      
      // Property info
      document.getElementById('result-address').textContent = analysis.property_address || 'Unknown';
      document.getElementById('result-date').textContent = new Date(analysis.analysis_timestamp || analysis.createdAt?.toDate()).toLocaleDateString();
      
      // Extra property details
      const detailsEl = document.getElementById('property-details-extra');
      if (analysis.property_details.bedrooms || analysis.property_details.square_feet) {
        detailsEl.innerHTML = `
          ${analysis.property_details.bedrooms ? `<div><span class="text-gray-600">Bedrooms:</span> <span class="font-semibold">${analysis.property_details.bedrooms}</span></div>` : ''}
          ${analysis.property_details.bathrooms ? `<div><span class="text-gray-600">Bathrooms:</span> <span class="font-semibold">${analysis.property_details.bathrooms}</span></div>` : ''}
          ${analysis.property_details.square_feet ? `<div><span class="text-gray-600">Square Feet:</span> <span class="font-semibold">${analysis.property_details.square_feet.toLocaleString()}</span></div>` : ''}
          ${analysis.property_details.property_type ? `<div><span class="text-gray-600">Type:</span> <span class="font-semibold">${analysis.property_details.property_type}</span></div>` : ''}
        `;
      }
      
      // Key metrics
      document.getElementById('result-value').textContent = '$' + (analysis.property_details?.estimated_value || 0).toLocaleString();
      document.getElementById('result-rent').textContent = '$' + (analysis.long_term_rental?.monthly_rent || 0).toLocaleString();
      document.getElementById('result-cap-rate').textContent = analysis.roi_percentage + '%';
      
      // ROI Grade with color
      const roiGrade = document.getElementById('result-roi-score');
      let grade, color, width;
      const roi = parseFloat(analysis.roi_percentage);
      
      if (roi >= 8) {
        grade = 'A+'; color = '#10b981'; width = '100%';
      } else if (roi >= 6) {
        grade = 'A'; color = '#22c55e'; width = '85%';
      } else if (roi >= 4) {
        grade = 'B'; color = '#3b82f6'; width = '70%';
      } else if (roi >= 2) {
        grade = 'C'; color = '#f59e0b'; width = '50%';
      } else {
        grade = 'D'; color = '#ef4444'; width = '30%';
      }
      
      roiGrade.textContent = grade;
      roiGrade.style.color = color;
      const roiBar = document.getElementById('roi-bar');
      roiBar.style.backgroundColor = color;
      roiBar.style.width = width;
      
      // Financial breakdown - correctly interpret annual vs monthly
      const monthlyRent = analysis.long_term_rental?.monthly_rent || 0;
      const mortgagePayment = analysis.costs?.mortgage_monthly || 0;
      
      // Determine if values are realistic annual amounts or likely monthly
      const propertyValue = analysis.property_details?.estimated_value || 850000;
      let monthlyTaxes, monthlyInsurance;
      
      // Property tax validation
      const taxAnnual = analysis.costs?.property_tax_annual || 0;
      if (taxAnnual > propertyValue * 0.02) {
        // This is likely monthly, not annual
        monthlyTaxes = taxAnnual;
      } else {
        // This is annual, convert to monthly
        monthlyTaxes = Math.round(taxAnnual / 12);
      }
      
      // Insurance validation  
      const insuranceAnnual = analysis.costs?.insurance_annual || 0;
      if (insuranceAnnual > propertyValue * 0.01) {
        // This is likely monthly, not annual
        monthlyInsurance = insuranceAnnual;
      } else {
        // This is annual, convert to monthly
        monthlyInsurance = Math.round(insuranceAnnual / 12);
      }
      
      const annualMaintenance = analysis.costs?.maintenance_annual || 0;
      const monthlyHoa = analysis.costs?.hoa_monthly || 0;
      
      // Monthly Income
      document.getElementById('breakdown-income').textContent = '$' + monthlyRent.toLocaleString();
      
      // Monthly Expenses  
      document.getElementById('breakdown-mortgage').textContent = '$' + mortgagePayment.toLocaleString();
      
      // Property Taxes - show monthly with annual reference
      document.getElementById('breakdown-taxes').textContent = '$' + monthlyTaxes.toLocaleString();
      const actualTaxAnnual = taxAnnual > propertyValue * 0.02 ? monthlyTaxes * 12 : taxAnnual;
      document.getElementById('breakdown-taxes-annual').textContent = '($' + actualTaxAnnual.toLocaleString() + '/year)';
      
      // Insurance - show monthly with annual reference  
      document.getElementById('breakdown-insurance').textContent = '$' + monthlyInsurance.toLocaleString();
      const actualInsuranceAnnual = insuranceAnnual > propertyValue * 0.01 ? monthlyInsurance * 12 : insuranceAnnual;
      document.getElementById('breakdown-insurance-annual').textContent = '($' + actualInsuranceAnnual.toLocaleString() + '/year)';
      
      // HOA - monthly only
      document.getElementById('breakdown-hoa').textContent = '$' + monthlyHoa.toLocaleString();
      
      // Maintenance - this is actually annual, show monthly equivalent
      const monthlyMaintenance = Math.round(annualMaintenance / 12);
      document.getElementById('breakdown-maintenance').textContent = '$' + monthlyMaintenance.toLocaleString();
      document.getElementById('breakdown-maintenance-annual').textContent = '($' + annualMaintenance.toLocaleString() + '/year)';
      
      // Property Management - default to 0% since most people self-manage
      const managementFee = 0; // Default to 0 instead of 8%
      document.getElementById('breakdown-management').textContent = '$' + managementFee.toLocaleString();
      document.getElementById('breakdown-management-rate').textContent = '(0% - self managed)';
      
      // Calculate net income (monthly) with corrected amounts
      const netIncome = monthlyRent - mortgagePayment - monthlyTaxes - monthlyInsurance - monthlyHoa - monthlyMaintenance - managementFee;
      document.getElementById('breakdown-net-income').textContent = '$' + netIncome.toLocaleString();
      
      // Initialize edit fields with current values (correcting the data structure)
      document.getElementById('edit-income').value = monthlyRent;
      document.getElementById('edit-mortgage').value = mortgagePayment;
      document.getElementById('edit-taxes').value = monthlyTaxes; // Store as monthly since that's what it actually is
      document.getElementById('edit-insurance').value = monthlyInsurance; // Store as monthly since that's what it actually is  
      document.getElementById('edit-hoa').value = monthlyHoa;
      document.getElementById('edit-maintenance').value = annualMaintenance; // This one is actually annual
      document.getElementById('edit-management').value = 0; // Default to 0%
      
      // Rental strategies
      document.getElementById('ltr-rent').textContent = '$' + (analysis.long_term_rental?.monthly_rent || 0).toLocaleString();
      document.getElementById('ltr-noi').textContent = '$' + (analysis.long_term_rental?.annual_profit || 0).toLocaleString();
      const ltrCapRate = ((analysis.long_term_rental?.annual_profit || 0) / (analysis.property_details?.estimated_value || 1) * 100).toFixed(2);
      document.getElementById('ltr-cap').textContent = ltrCapRate + '%';
      document.getElementById('ltr-roi').textContent = ltrCapRate + '%';
      
      document.getElementById('str-rate').textContent = '$' + (analysis.short_term_rental?.daily_rate || 0);
      document.getElementById('str-occupancy').textContent = (analysis.short_term_rental?.occupancy_rate || 0) + '%';
      document.getElementById('str-revenue').textContent = '$' + (analysis.short_term_rental?.annual_revenue || 0).toLocaleString();
      const strROI = ((analysis.short_term_rental?.annual_profit || 0) / (analysis.property_details?.estimated_value || 1) * 100).toFixed(2);
      document.getElementById('str-roi').textContent = strROI + '%';
      
      document.getElementById('investment-recommendation').textContent = analysis.recommendation || 'No recommendation available';
      
      // Market data if available
      if (analysis.market_data) {
        document.getElementById('market-data-section').style.display = 'block';
        document.getElementById('days-on-market').textContent = analysis.market_data.days_on_market || 'N/A';
        document.getElementById('appreciation-rate').textContent = (analysis.market_data.appreciation_rate || 'N/A') + '%';
        document.getElementById('comparable-count').textContent = (analysis.market_data.comparable_sales?.length || 0) + ' properties';
      }
      
      // Enhanced Data sources display
      displayDataSources(analysis);
      
      // Initialize edit mode
      initializeEditMode();
      
      // Create Charts
      createCharts(analysis);
      
      // Mount STR comparison view if data exists
      mountRentalComparisonView(analysis);
      
      // Store analysis ID if available
      currentAnalysisId = analysis.id || analysis._id || null;
    }

    // Create charts
    function createCharts(analysis) {
      // Destroy existing charts
      if (charts.cashFlow) charts.cashFlow.destroy();
      if (charts.roiComparison) charts.roiComparison.destroy();
      
      // Cash Flow Chart
      const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
      
      // Prepare chart data including mortgage if present
      const monthlyIncome = analysis.long_term_rental?.monthly_rent || 0;
      const mortgagePayment = analysis.costs?.mortgage_monthly || 0;
      const chartLabels = ['Income'];
      const chartData = [monthlyIncome];
      
      if (mortgagePayment > 0) {
        chartLabels.push('Mortgage');
        chartData.push(-mortgagePayment);
      }
      
      chartLabels.push('Taxes', 'Insurance', 'HOA', 'Maint.', 'Mgmt.', 'Net');
      chartData.push(
        -Math.round((analysis.costs?.property_tax_annual || 0) / 12),
        -Math.round((analysis.costs?.insurance_annual || 0) / 12),
        -(analysis.costs?.hoa_monthly || 0),
        -Math.round((analysis.costs?.maintenance_annual || 0) / 12),
        -Math.round(monthlyIncome * 0.08),
        monthlyIncome - mortgagePayment - Math.round((analysis.costs?.property_tax_annual || 0) / 12) - 
        Math.round((analysis.costs?.insurance_annual || 0) / 12) - (analysis.costs?.hoa_monthly || 0) - 
        Math.round((analysis.costs?.maintenance_annual || 0) / 12) - Math.round(monthlyIncome * 0.08)
      );
      
      charts.cashFlow = new Chart(cashFlowCtx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Monthly Cash Flow',
            data: chartData,
            backgroundColor: function(context) {
              const value = context.dataset.data[context.dataIndex];
              return value >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + (value/1000).toFixed(0) + 'k';
                }
              }
            }
          }
        }
      });
      
      // ROI Comparison Chart
      const roiCtx = document.getElementById('roiComparisonChart').getContext('2d');
      charts.roiComparison = new Chart(roiCtx, {
        type: 'doughnut',
        data: {
          labels: ['Long-term Rental', 'Short-term Rental (Airbnb)', 'Traditional Investment (4%)'],
          datasets: [{
            data: [
              ((analysis.long_term_rental?.annual_profit || 0) / (analysis.property_details?.estimated_value || 1) * 100).toFixed(2),
              ((analysis.short_term_rental?.annual_profit || 0) / (analysis.property_details?.estimated_value || 1) * 100).toFixed(2),
              4
            ],
            backgroundColor: [
              'rgba(59, 130, 246, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(156, 163, 175, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.parsed + '% ROI';
                }
              }
            }
          }
        }
      });
    }

    // Enhanced Data Sources Display
    function displayDataSources(analysis) {
      const sourcesContainer = document.getElementById('sources-container');
      const sources = analysis.data_sources || analysis.research_sources || [];
      
      // Count sources by type
      const sourceTypes = {
        property: sources.filter(s => s.name?.includes('Realtor') || s.name?.includes('House') || s.name?.includes('Zolo')).length,
        tax: sources.filter(s => s.description?.toLowerCase().includes('tax') || s.name?.includes('Government')).length,
        insurance: sources.filter(s => s.description?.toLowerCase().includes('insurance')).length,
        rental: sources.filter(s => s.name?.includes('Rental') || s.name?.includes('Kijiji') || s.name?.includes('Airbnb')).length
      };
      
      if (sources.length > 0) {
        // Add data transparency summary
        let transparencySummary = `
          <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="font-medium text-blue-900">Data Transparency Summary</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
              <div class="flex items-center gap-1">
                <span class="${sourceTypes.property > 0 ? 'text-green-600' : 'text-gray-400'}">●</span>
                <span>Property Data: ${sourceTypes.property > 0 ? 'Verified' : 'Estimated'}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="${sourceTypes.tax > 0 ? 'text-green-600' : 'text-orange-500'}">●</span>
                <span>Tax Rates: ${sourceTypes.tax > 0 ? 'Official' : 'Market Average'}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="${sourceTypes.insurance > 0 ? 'text-green-600' : 'text-orange-500'}">●</span>
                <span>Insurance: ${sourceTypes.insurance > 0 ? 'Provider Data' : 'Industry Average'}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="${sourceTypes.rental > 0 ? 'text-green-600' : 'text-gray-400'}">●</span>
                <span>Rentals: ${sourceTypes.rental > 0 ? 'Market Data' : 'Estimated'}</span>
              </div>
            </div>
          </div>
        `;
        
        sourcesContainer.innerHTML = transparencySummary + sources.map((source, index) => {
          const hasValidUrl = source.url && source.url !== '#' && !source.url.includes('dashboard');
          const sourceName = source.name || source.title || `Data Source ${index + 1}`;
          const sourceDate = source.date || source.data_date || 'Recently accessed';
          const sourceDesc = source.description || 'Research source';
          
          // Determine icon color based on source type
          let iconColor = 'blue';
          if (sourceName.includes('Government') || sourceDesc.includes('tax')) iconColor = 'green';
          else if (sourceDesc.includes('insurance')) iconColor = 'purple';
          else if (sourceName.includes('Rental') || sourceName.includes('Airbnb')) iconColor = 'orange';
          
          return `
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-3 flex-1">
                  <div class="w-8 h-8 bg-${iconColor}-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                    <svg class="w-4 h-4 text-${iconColor}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="font-medium text-gray-900">${sourceName}</p>
                    <p class="text-sm text-gray-600 mt-1">${sourceDesc}</p>
                    <p class="text-xs text-gray-500 mt-1">Accessed: ${sourceDate}</p>
                    ${hasValidUrl ? `
                      <p class="text-xs text-gray-400 mt-1 font-mono break-all">${source.url}</p>
                    ` : `
                      <p class="text-xs text-orange-500 mt-1">⚠️ Source URL not captured - data from AI research</p>
                    `}
                  </div>
                </div>
                <div class="ml-4">
                  ${hasValidUrl ? `
                    <a href="${source.url}" target="_blank" rel="noopener noreferrer" 
                       class="inline-flex items-center px-3 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded-full hover:bg-blue-200 transition-colors">
                      View Source
                      <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  ` : `
                    <span class="inline-flex items-center px-3 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded-full">
                      AI Research
                    </span>
                  `}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        sourcesContainer.innerHTML = `
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
            <svg class="w-8 h-8 text-yellow-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <p class="text-sm text-yellow-800 font-medium">Limited source data available</p>
            <p class="text-xs text-yellow-700 mt-1">Analysis based on AI market research - source URLs may not be captured</p>
            <p class="text-xs text-yellow-700 mt-1">For best results, verify property tax rates with local municipality</p>
          </div>
        `;
      }
    }

    // Initialize Edit Mode
    function initializeEditMode() {
      editMode = false;
      
      // Check if elements exist before trying to manipulate them
      const resetBtn = document.getElementById('reset-financials-btn');
      if (resetBtn) {
        resetBtn.style.display = 'none';
      }
      
      // Hide all edit inputs
      const editInputs = document.querySelectorAll('[id^="edit-"]');
      const displayElements = document.querySelectorAll('#breakdown-income, #breakdown-mortgage, #breakdown-taxes, #breakdown-insurance, #breakdown-hoa, #breakdown-maintenance, #breakdown-management');
      
      editInputs.forEach(input => {
        if (input) input.classList.add('hidden');
      });
      displayElements.forEach(el => {
        if (el) el.classList.remove('hidden');
      });
    }

    // Toggle Edit Mode
    function toggleEditMode() {
      editMode = !editMode;
      const editBtn = document.getElementById('edit-financials-btn');
      const resetBtn = document.getElementById('reset-financials-btn');
      
      const editInputs = document.querySelectorAll('[id^="edit-"]');
      const displayElements = document.querySelectorAll('#breakdown-income, #breakdown-mortgage, #breakdown-taxes, #breakdown-insurance, #breakdown-hoa, #breakdown-maintenance, #breakdown-management');
      
      if (editMode) {
        editBtn.textContent = 'Save Changes';
        editBtn.className = 'px-3 py-1 text-sm bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors';
        resetBtn.style.display = 'inline-block';
        
        editInputs.forEach(input => input.classList.remove('hidden'));
        displayElements.forEach(el => el.classList.add('hidden'));
        
        // Add event listeners for real-time updates
        editInputs.forEach(input => {
          input.addEventListener('input', updateCalculations);
        });
      } else {
        editBtn.textContent = 'Edit Values';
        editBtn.className = 'px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors';
        
        editInputs.forEach(input => input.classList.add('hidden'));
        displayElements.forEach(el => el.classList.remove('hidden'));
        
        // Update the current analysis with new values
        updateAnalysisData();
      }
    }

    // Update Calculations
    function updateCalculations() {
      // Parse and validate inputs (ensure non-negative values)
      const income = Math.max(0, parseFloat(document.getElementById('edit-income').value) || 0);
      const mortgage = Math.max(0, parseFloat(document.getElementById('edit-mortgage').value) || 0);
      const monthlyTaxes = Math.max(0, parseFloat(document.getElementById('edit-taxes').value) || 0); // Now monthly
      const monthlyInsurance = Math.max(0, parseFloat(document.getElementById('edit-insurance').value) || 0); // Now monthly
      const hoa = Math.max(0, parseFloat(document.getElementById('edit-hoa').value) || 0);
      const annualMaintenance = Math.max(0, parseFloat(document.getElementById('edit-maintenance').value) || 0); // Still annual
      const managementRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('edit-management').value) || 0)); // 0-100%
      
      // Calculate monthly amounts
      const monthlyMaintenance = Math.round(annualMaintenance / 12);
      const managementFee = Math.round(income * (managementRate / 100));
      
      const netIncome = income - mortgage - monthlyTaxes - monthlyInsurance - hoa - monthlyMaintenance - managementFee;
      
      // Update all monthly displays
      document.getElementById('breakdown-income').textContent = `$${income.toLocaleString()}`;
      document.getElementById('breakdown-mortgage').textContent = `$${mortgage.toLocaleString()}`;
      document.getElementById('breakdown-taxes').textContent = `$${monthlyTaxes.toLocaleString()}`;
      document.getElementById('breakdown-taxes-annual').textContent = `($${(monthlyTaxes * 12).toLocaleString()}/year)`;
      document.getElementById('breakdown-insurance').textContent = `$${monthlyInsurance.toLocaleString()}`;
      document.getElementById('breakdown-insurance-annual').textContent = `($${(monthlyInsurance * 12).toLocaleString()}/year)`;
      document.getElementById('breakdown-hoa').textContent = `$${hoa.toLocaleString()}`;
      document.getElementById('breakdown-maintenance').textContent = `$${monthlyMaintenance.toLocaleString()}`;
      document.getElementById('breakdown-maintenance-annual').textContent = `($${annualMaintenance.toLocaleString()}/year)`;
      document.getElementById('breakdown-management').textContent = `$${managementFee.toLocaleString()}`;
      const managementText = managementRate > 0 ? `(${managementRate}% of rent)` : '(0% - self managed)';
      document.getElementById('breakdown-management-rate').textContent = managementText;
      document.getElementById('breakdown-net-income').textContent = `$${netIncome.toLocaleString()}`;
      
      // Update charts with new data
      if (currentAnalysis) {
        const updatedAnalysis = { ...currentAnalysis };
        updatedAnalysis.long_term_rental.monthly_rent = income;
        updatedAnalysis.costs.mortgage_monthly = mortgage;
        updatedAnalysis.costs.property_tax_annual = monthlyTaxes; // Store as-is since data structure is inconsistent
        updatedAnalysis.costs.insurance_annual = monthlyInsurance; // Store as-is since data structure is inconsistent  
        updatedAnalysis.costs.hoa_monthly = hoa;
        updatedAnalysis.costs.maintenance_annual = annualMaintenance;
        
        createCharts(updatedAnalysis);
      }
    }

    // Update Analysis Data
    function updateAnalysisData() {
      if (!currentAnalysis) return;
      
      currentAnalysis.long_term_rental.monthly_rent = parseFloat(document.getElementById('edit-income').value) || 0;
      currentAnalysis.costs.mortgage_monthly = parseFloat(document.getElementById('edit-mortgage').value) || 0;
      currentAnalysis.costs.property_tax_annual = parseFloat(document.getElementById('edit-taxes').value) || 0;
      currentAnalysis.costs.insurance_annual = parseFloat(document.getElementById('edit-insurance').value) || 0;
      currentAnalysis.costs.hoa_monthly = parseFloat(document.getElementById('edit-hoa').value) || 0;
      currentAnalysis.costs.maintenance_annual = parseFloat(document.getElementById('edit-maintenance').value) || 0;
      
      // Recalculate derived values
      const income = currentAnalysis.long_term_rental.monthly_rent;
      const mortgage = currentAnalysis.costs.mortgage_monthly;
      const annualRevenue = income * 12;
      const annualMortgage = mortgage * 12;
      const totalAnnualExpenses = currentAnalysis.costs.property_tax_annual + 
                                  currentAnalysis.costs.insurance_annual + 
                                  (currentAnalysis.costs.hoa_monthly * 12) + 
                                  currentAnalysis.costs.maintenance_annual + 
                                  (annualRevenue * 0.08) + annualMortgage;
      
      currentAnalysis.long_term_rental.annual_revenue = annualRevenue;
      currentAnalysis.long_term_rental.annual_profit = annualRevenue - totalAnnualExpenses;
      
      // Update the display
      displayResults(currentAnalysis);
    }

    // Reset to Original Values
    function resetToOriginal() {
      if (!originalAnalysis) return;
      
      currentAnalysis = JSON.parse(JSON.stringify(originalAnalysis));
      displayResults(currentAnalysis);
      
      // Exit edit mode
      if (editMode) {
        toggleEditMode();
      }
    }

    // Open Chart Details Modal
    function openChartDetails(chartType) {
      if (!currentAnalysis) return;
      
      const modal = document.getElementById('chart-details-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalContent = document.getElementById('modal-content');
      
      if (chartType === 'cashFlow') {
        modalTitle.textContent = 'Cash Flow Analysis - Detailed Breakdown';
        modalContent.innerHTML = generateCashFlowDetails(currentAnalysis);
      } else if (chartType === 'roiComparison') {
        modalTitle.textContent = 'ROI Comparison - Detailed Analysis';
        modalContent.innerHTML = generateROIComparisonDetails(currentAnalysis);
      }
      
      modal.classList.remove('hidden');
    }

    // Close Chart Details Modal
    function closeChartDetails() {
      document.getElementById('chart-details-modal').classList.add('hidden');
    }

    // Generate Cash Flow Details
    function generateCashFlowDetails(analysis) {
      const income = analysis.long_term_rental?.monthly_rent || 0;
      const mortgage = analysis.costs?.mortgage_monthly || 0;
      const taxes = Math.round((analysis.costs?.property_tax_annual || 0) / 12);
      const insurance = Math.round((analysis.costs?.insurance_annual || 0) / 12);
      const hoa = analysis.costs?.hoa_monthly || 0;
      const maintenance = Math.round((analysis.costs?.maintenance_annual || 0) / 12);
      const management = Math.round(income * 0.08);
      const net = income - mortgage - taxes - insurance - hoa - maintenance - management;
      
      return `
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
              <h4 class="font-semibold text-green-800 mb-3">Monthly Income</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-green-700">Rental Income:</span>
                  <span class="font-semibold text-green-800">$${income.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-green-700">Percentage:</span>
                  <span class="font-semibold text-green-800">100%</span>
                </div>
              </div>
            </div>
            
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <h4 class="font-semibold text-red-800 mb-3">Monthly Expenses</h4>
              <div class="space-y-2 text-sm">
                ${mortgage > 0 ? `
                <div class="flex justify-between">
                  <span class="text-red-700">Mortgage Payment:</span>
                  <span class="font-semibold">$${mortgage.toLocaleString()} (${((mortgage/income)*100).toFixed(1)}%)</span>
                </div>` : ''}
                <div class="flex justify-between">
                  <span class="text-red-700">Property Taxes:</span>
                  <span class="font-semibold">$${taxes.toLocaleString()} (${((taxes/income)*100).toFixed(1)}%)</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-red-700">Insurance:</span>
                  <span class="font-semibold">$${insurance.toLocaleString()} (${((insurance/income)*100).toFixed(1)}%)</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-red-700">HOA/Condo Fees:</span>
                  <span class="font-semibold">$${hoa.toLocaleString()} (${((hoa/income)*100).toFixed(1)}%)</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-red-700">Maintenance:</span>
                  <span class="font-semibold">$${maintenance.toLocaleString()} (${((maintenance/income)*100).toFixed(1)}%)</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-red-700">Property Management:</span>
                  <span class="font-semibold">$${management.toLocaleString()} (${((management/income)*100).toFixed(1)}%)</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h4 class="font-semibold text-blue-800 mb-3">Net Operating Income</h4>
            <div class="flex justify-between items-center">
              <span class="text-blue-700">Monthly Net Income:</span>
              <span class="text-2xl font-bold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">
                $${net.toLocaleString()}
              </span>
            </div>
            <div class="flex justify-between items-center mt-2">
              <span class="text-blue-700">Annual Net Income:</span>
              <span class="text-xl font-semibold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">
                $${(net * 12).toLocaleString()}
              </span>
            </div>
            <div class="mt-3 text-sm text-blue-700">
              <p><strong>Cash-on-Cash ROI:</strong> ${((net * 12) / (analysis.property_details?.estimated_value || 1) * 100).toFixed(2)}%</p>
            </div>
          </div>
        </div>
      `;
    }

    // Generate ROI Comparison Details
    function generateROIComparisonDetails(analysis) {
      const propertyValue = analysis.property_details?.estimated_value || 1;
      const ltrProfit = analysis.long_term_rental?.annual_profit || 0;
      const strProfit = analysis.short_term_rental?.annual_profit || 0;
      const ltrROI = (ltrProfit / propertyValue * 100);
      const strROI = (strProfit / propertyValue * 100);
      const traditionalROI = 4;
      
      return `
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <h4 class="font-semibold text-blue-800 mb-3">Long-term Rental</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Monthly Rent:</span>
                  <span class="font-semibold">$${(analysis.long_term_rental?.monthly_rent || 0).toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span>Annual Revenue:</span>
                  <span class="font-semibold">$${(analysis.long_term_rental?.annual_revenue || 0).toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span>Annual Profit:</span>
                  <span class="font-semibold">$${ltrProfit.toLocaleString()}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                  <span class="font-semibold">ROI:</span>
                  <span class="font-bold text-blue-600">${ltrROI.toFixed(2)}%</span>
                </div>
              </div>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
              <h4 class="font-semibold text-green-800 mb-3">Short-term Rental</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Daily Rate:</span>
                  <span class="font-semibold">$${analysis.short_term_rental?.daily_rate || 0}</span>
                </div>
                <div class="flex justify-between">
                  <span>Occupancy Rate:</span>
                  <span class="font-semibold">${analysis.short_term_rental?.occupancy_rate || 0}%</span>
                </div>
                <div class="flex justify-between">
                  <span>Annual Revenue:</span>
                  <span class="font-semibold">$${(analysis.short_term_rental?.annual_revenue || 0).toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span>Annual Profit:</span>
                  <span class="font-semibold">$${strProfit.toLocaleString()}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                  <span class="font-semibold">ROI:</span>
                  <span class="font-bold text-green-600">${strROI.toFixed(2)}%</span>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <h4 class="font-semibold text-gray-800 mb-3">Traditional Investment</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Investment Amount:</span>
                  <span class="font-semibold">$${propertyValue.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span>Annual Return:</span>
                  <span class="font-semibold">$${(propertyValue * 0.04).toLocaleString()}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                  <span class="font-semibold">ROI:</span>
                  <span class="font-bold text-gray-600">4.0%</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <h4 class="font-semibold text-yellow-800 mb-2">Investment Comparison Summary</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="text-center">
                <p class="font-semibold">Best ROI Strategy</p>
                <p class="text-lg font-bold ${strROI > ltrROI ? 'text-green-600' : 'text-blue-600'}">
                  ${strROI > ltrROI ? 'Short-term Rental' : 'Long-term Rental'}
                </p>
              </div>
              <div class="text-center">
                <p class="font-semibold">vs Traditional Investment</p>
                <p class="text-lg font-bold text-green-600">
                  +${Math.max(ltrROI, strROI, traditionalROI) - traditionalROI > 0 ? (Math.max(ltrROI, strROI) - traditionalROI).toFixed(1) : '0'}% better
                </p>
              </div>
              <div class="text-center">
                <p class="font-semibold">Annual Difference</p>
                <p class="text-lg font-bold text-green-600">
                  $${(Math.max(ltrProfit, strProfit) - (propertyValue * 0.04)).toLocaleString()}
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners...');

      // Auth form
      document.getElementById('auth-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const name = document.getElementById('name').value;
        
        try {
          if (authMode === 'signup') {
            const result = await firebase.auth().createUserWithEmailAndPassword(email, password);
            await result.user.updateProfile({ displayName: name });
          } else {
            await firebase.auth().signInWithEmailAndPassword(email, password);
          }
        } catch (error) {
          document.getElementById('auth-error').textContent = error.message;
          document.getElementById('auth-error').style.display = 'block';
        }
      });

      // Auth mode switch
      document.getElementById('auth-switch').addEventListener('click', function() {
        authMode = authMode === 'signin' ? 'signup' : 'signin';
        updateAuthMode();
        document.getElementById('auth-error').style.display = 'none';
      });

      // Sign out
      document.getElementById('sign-out-btn').addEventListener('click', function() {
        // Clear localStorage auth data
        localStorage.removeItem('starterpack_auth_token');
        localStorage.removeItem('starterpack_user');
        console.log('[StarterPack] Cleared auth data from localStorage');
        
        firebase.auth().signOut();
      });

      // New analysis button
      document.getElementById('new-analysis-btn').addEventListener('click', function() {
        console.log('New analysis button clicked!');
        document.getElementById('debug-text').textContent = 'Button clicked! Opening form...';
        showView('property-form');
      });

      // Back to dashboard
      document.getElementById('back-to-dashboard').addEventListener('click', function() {
        showView('dashboard');
      });

      // Property form
      document.getElementById('property-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
          // Show loading state
          submitBtn.innerHTML = `
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            Analyzing Property...
          `;
          submitBtn.disabled = true;
          
          const address = {
            street: document.getElementById('street').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            country: document.getElementById('country').value,
            postal: document.getElementById('postal').value
          };
          
          console.log('Starting analysis for address:', address);
          
          // Perform analysis
          const analysis = await analyzeProperty(address);
          
          // Display results
          displayResults(analysis);
          showView('results');
          
          // Update user profile
          if (userProfile && currentUser) {
            try {
              const db = firebase.firestore();
              await db.collection('users').doc(currentUser.uid).update({
                monthlyAnalysisCount: (userProfile.monthlyAnalysisCount || 0) + 1
              });
              userProfile.monthlyAnalysisCount = (userProfile.monthlyAnalysisCount || 0) + 1;
              updateDashboard();
            } catch (error) {
              console.error('Failed to update analysis count:', error);
            }
          }
          
          // Reload analyses list
          loadUserAnalyses();
          
        } catch (error) {
          console.error('Analysis failed:', error);
          alert('Analysis failed: ' + error.message);
        } finally {
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });

      // Results screen buttons
      document.getElementById('back-to-dashboard-results').addEventListener('click', function() {
        showView('dashboard');
      });

      document.getElementById('new-analysis-from-results').addEventListener('click', function() {
        // Clear form fields
        document.getElementById('street').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('country').value = '';
        document.getElementById('postal').value = '';
        showView('property-form');
      });

      document.getElementById('save-analysis').addEventListener('click', function() {
        alert('Analysis saved to your dashboard!');
        showView('dashboard');
      });

      // Edit financials button - with error checking
      const editBtn = document.getElementById('edit-financials-btn');
      if (editBtn) {
        console.log('Edit button found and adding listener');
        editBtn.addEventListener('click', function() {
          toggleEditMode();
        });
      } else {
        console.error('Edit button NOT found in DOM!');
      }

      // Reset financials button - with error checking
      const resetBtn = document.getElementById('reset-financials-btn');
      if (resetBtn) {
        console.log('Reset button found and adding listener');
        resetBtn.addEventListener('click', function() {
          resetToOriginal();
        });
      } else {
        console.error('Reset button NOT found in DOM!');
      }

      // Initialize the app
      initApp();
    });

    console.log('Script setup complete');
    // Load and mount RentalComparisonView component
    function mountRentalComparisonView(analysisData) {
      console.log('Mounting RentalComparisonView with data:', analysisData);
      const container = document.getElementById('str-comparison-container');
      if (!container) {
        console.error('str-comparison-container not found');
        return;
      }
      
      // Check if STR data exists - handle both API response formats
      const hasSTR = analysisData.strAnalysis || analysisData.short_term_rental;
      console.log('Has STR data:', hasSTR);
      
      if (hasSTR) {
        container.style.display = 'block';
        
        // Transform data to match component expectations
        const transformedData = {
          longTermRental: analysisData.long_term_rental || analysisData.longTermRental,
          strAnalysis: analysisData.strAnalysis || analysisData.short_term_rental,
          comparison: analysisData.comparison,
          propertyDetails: analysisData.property_details || analysisData.propertyDetails
        };
        
        console.log('Transformed data:', transformedData);
        
        // Check if React and ReactDOM are loaded
        if (!window.React || !window.ReactDOM) {
          console.error('React or ReactDOM not loaded');
          return;
        }
        
        // Check if component is already loaded
        if (window.RentalComparisonView) {
          console.log('Component already loaded, mounting...');
          try {
            // Component already loaded, just mount it
            ReactDOM.render(
              React.createElement(window.RentalComparisonView, { 
                analysis: transformedData,
                propertyAddress: analysisData.property_address || 'Property Analysis'
              }),
              container
            );
            console.log('Component mounted successfully');
          } catch (error) {
            console.error('Error mounting component:', error);
          }
        } else {
          console.log('Component not loaded, loading script...');
          // Wait for Babel to be ready
          const checkBabelAndLoad = () => {
            if (window.Babel) {
              console.log('Babel is ready, loading component...');
              // Load component script first
              const script = document.createElement('script');
              script.type = 'text/babel';
              script.src = '/components/RentalComparisonView.jsx';
              script.onload = () => {
                console.log('Component script loaded');
                // Give Babel time to transform the JSX
                setTimeout(() => {
                  if (window.RentalComparisonView) {
                    console.log('Component available, mounting...');
                    try {
                      ReactDOM.render(
                        React.createElement(window.RentalComparisonView, { 
                          analysis: transformedData,
                          propertyAddress: analysisData.property_address || 'Property Analysis'
                        }),
                        container
                      );
                      console.log('Component mounted successfully');
                    } catch (error) {
                      console.error('Error mounting component:', error);
                    }
                  } else {
                    console.error('Component not available after loading script');
                  }
                }, 1000);
              };
              script.onerror = (error) => {
                console.error('Error loading component script:', error);
              };
              document.body.appendChild(script);
            } else {
              console.log('Babel not ready, retrying...');
              setTimeout(checkBabelAndLoad, 100);
            }
          };
          checkBabelAndLoad();
        }
      } else {
        container.style.display = 'none';
        console.log('No STR data, hiding container');
      }
    }
    
    // Presentation Mode Functions
    let isPresentationMode = false;
    let currentAnalysisId = null;
    
    function togglePresentationMode() {
      isPresentationMode = document.getElementById('presentation-mode-toggle').checked;
      
      if (isPresentationMode) {
        // Show presentation view
        document.getElementById('share-client-btn').style.display = 'flex';
        document.getElementById('realtor-branding').style.display = 'block';
        
        // Set realtor info
        if (currentUser) {
          document.getElementById('realtor-name').textContent = currentUser.displayName || 'Your Realtor';
          document.getElementById('realtor-contact').textContent = currentUser.email || '';
        }
        
        // Mount presentation component if we have analysis data
        if (currentAnalysis) {
          mountClientPresentation(currentAnalysis);
        }
      } else {
        // Hide presentation view
        document.getElementById('share-client-btn').style.display = 'none';
        document.getElementById('realtor-branding').style.display = 'none';
        document.getElementById('client-presentation-container').style.display = 'none';
        
        // Show normal views
        if (currentAnalysis) {
          displayResults(currentAnalysis);
        }
      }
    }
    
    function mountClientPresentation(analysisData) {
      const container = document.getElementById('client-presentation-container');
      if (!container) return;
      
      // Hide other views
      document.getElementById('str-comparison-container').style.display = 'none';
      document.querySelectorAll('.card').forEach(card => card.style.display = 'none');
      
      // Show presentation container
      container.style.display = 'block';
      
      // Check if component is loaded
      if (window.ClientPresentationView) {
        const realtorInfo = {
          name: currentUser?.displayName || 'Your Realtor',
          email: currentUser?.email || '',
          phone: currentUser?.phoneNumber || '',
          logo: currentUser?.photoURL || null
        };
        
        ReactDOM.render(
          React.createElement(window.ClientPresentationView, {
            analysis: analysisData,
            propertyAddress: analysisData.property_address || 'Investment Property',
            realtorInfo: realtorInfo,
            clientName: null,
            presentationMode: true
          }),
          container
        );
      } else {
        // Load component if not already loaded
        const script = document.createElement('script');
        script.type = 'text/babel';
        script.src = '/components/ClientPresentationView.jsx';
        script.onload = () => {
          setTimeout(() => {
            if (window.ClientPresentationView) {
              mountClientPresentation(analysisData);
            }
          }, 1000);
        };
        document.body.appendChild(script);
      }
    }
    
    async function shareWithClient() {
      if (!currentAnalysisId) {
        alert('Please run an analysis first');
        return;
      }
      
      // Prompt for client info
      const clientName = prompt('Client name (optional):');
      const clientEmail = prompt('Client email (optional):');
      
      try {
        const response = await fetch('/api/reports/client-presentation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${await currentUser.getIdToken()}`
          },
          body: JSON.stringify({
            analysisId: currentAnalysisId,
            clientName: clientName || null,
            clientEmail: clientEmail || null,
            realtorBranding: {
              name: currentUser.displayName || 'Your Realtor',
              email: currentUser.email,
              phone: currentUser.phoneNumber || null,
              logo: currentUser.photoURL || null
            },
            expiryDays: 7
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show share modal
          const shareUrl = result.shareUrl;
          const modal = confirm(`Client presentation created!\n\nShare URL: ${shareUrl}\n\nCopy this link?`);
          
          if (modal) {
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
              alert('Link copied to clipboard!');
            });
          }
        } else {
          alert('Failed to create presentation: ' + result.error);
        }
      } catch (error) {
        console.error('Share error:', error);
        alert('Failed to create shareable link');
      }
    }
  </script>
</body>
</html>
