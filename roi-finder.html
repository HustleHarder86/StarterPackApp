<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROI Finder - InvestorProps</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 auto;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    /* Form styles */
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Card styles */
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Loading Screen -->
  <div id="loading-screen" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading ROI Finder...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2" id="auth-title">Welcome Back</h1>
        <p class="text-gray-600" id="auth-subtitle">Sign in to access your property analyses</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="auth-form">
          <div class="space-y-6">
            <div id="name-field" style="display: none;">
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input type="text" id="name" class="form-input" placeholder="John Doe" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="email" class="form-input" placeholder="john@example.com" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input type="password" id="password" class="form-input" placeholder="••••••••" required minlength="6" />
            </div>

            <div id="auth-error" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm" style="display: none;"></div>

            <button type="submit" class="btn-primary w-full">
              <span id="auth-button-text">Sign In</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <p class="text-gray-600">
            <span id="auth-switch-text">Don't have an account? </span>
            <button id="auth-switch" class="text-blue-600 hover:text-blue-800 font-semibold">Sign Up</button>
          </p>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <a href="index.html" class="text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1">
            ← Back to Homepage
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-screen" class="min-h-screen bg-gray-50" style="display: none;">
    <!-- Header -->
    <div class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">InvestorProps</h1>
            <span class="text-sm text-gray-500">Dashboard</span>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm text-gray-700" id="user-email"></span>
            <button id="sign-out-btn" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
          <p class="text-sm text-gray-600">Analyses Used</p>
          <p class="text-2xl font-bold text-gray-900" id="analysis-count">0 / 3</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Subscription</p>
          <p class="text-2xl font-bold text-gray-900" id="subscription-tier">Trial</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Total Analyses</p>
          <p class="text-2xl font-bold text-gray-900" id="total-analyses">0</p>
        </div>
      </div>

      <!-- New Analysis Button -->
      <div class="text-center mb-8">
        <button id="new-analysis-btn" class="btn-primary">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          New Property Analysis
        </button>
        <p class="text-xs text-gray-500 mt-2" id="debug-text">Ready to analyze properties</p>
      </div>

      <!-- Recent Analyses -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Recent Analyses</h2>
        </div>
        <div id="analyses-list" class="divide-y divide-gray-200">
          <div class="px-6 py-12 text-center text-gray-500">
            No analyses yet. Click "New Property Analysis" to get started!
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Input Form -->
  <div id="property-form-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Property ROI Analyzer</h1>
        <p class="text-gray-600">Get AI-powered investment analysis for any property worldwide</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="property-form">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
              <input type="text" id="street" class="form-input" placeholder="123 Main Street" required />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                <input type="text" id="city" class="form-input" placeholder="Toronto" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">State/Province *</label>
                <input type="text" id="state" class="form-input" placeholder="Ontario" required />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                <input type="text" id="country" class="form-input" placeholder="Canada" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Postal/Zip Code</label>
                <input type="text" id="postal" class="form-input" placeholder="M5V 3A8" />
              </div>
            </div>

            <button type="submit" class="btn-primary w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Analyze Property
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between">
          <button id="back-to-dashboard" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
            ← Back to Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Results Screen -->
  <div id="results-screen" class="min-h-screen bg-gray-50" style="display: none;">
    <!-- Header -->
    <div class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">Property Analysis Results</h1>
          </div>
          <div class="flex items-center gap-4">
            <button id="back-to-dashboard-results" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              ← Back to Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Property Info -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Property Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-600">Address</p>
              <p class="font-semibold" id="result-address">-</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Analysis Date</p>
              <p class="font-semibold" id="result-date">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card">
          <p class="text-sm text-gray-600">Estimated Value</p>
          <p class="text-2xl font-bold text-gray-900" id="result-value">-</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Monthly Rent</p>
          <p class="text-2xl font-bold text-gray-900" id="result-rent">-</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Cap Rate</p>
          <p class="text-2xl font-bold text-green-600" id="result-cap-rate">-</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">ROI Score</p>
          <p class="text-3xl font-bold" id="result-roi-score">-</p>
        </div>
      </div>

      <!-- Detailed Analysis -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Financial Breakdown -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Financial Breakdown</h3>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <div class="flex justify-between">
                <span class="text-gray-600">Estimated Property Value</span>
                <span class="font-semibold" id="breakdown-value">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Monthly Rental Income</span>
                <span class="font-semibold text-green-600" id="breakdown-income">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Annual Rental Income</span>
                <span class="font-semibold text-green-600" id="breakdown-annual-income">-</span>
              </div>
              <div class="border-t pt-2">
                <div class="flex justify-between">
                  <span class="text-gray-600">Property Taxes (Est.)</span>
                  <span class="font-semibold text-red-600" id="breakdown-taxes">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Insurance (Est.)</span>
                  <span class="font-semibold text-red-600" id="breakdown-insurance">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Maintenance (Est.)</span>
                  <span class="font-semibold text-red-600" id="breakdown-maintenance">-</span>
                </div>
                <div class="flex justify-between" id="breakdown-hoa-row" style="display: none;">
                  <span class="text-gray-600">HOA Fees (Annual)</span>
                  <span class="font-semibold text-red-600" id="breakdown-hoa">-</span>
                </div>
                <div class="flex justify-between" id="breakdown-utilities-row" style="display: none;">
                  <span class="text-gray-600">Utilities (Annual)</span>
                  <span class="font-semibold text-red-600" id="breakdown-utilities">-</span>
                </div>
              </div>
              <div class="border-t pt-2">
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-900">Net Annual Income</span>
                  <span class="font-bold text-green-600" id="breakdown-net-income">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Investment Analysis -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Investment Analysis</h3>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-600">Cap Rate</span>
                  <span class="font-semibold" id="analysis-cap-rate">-</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full" id="cap-rate-bar" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-600">Cash-on-Cash Return</span>
                  <span class="font-semibold" id="analysis-cash-return">-</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" id="cash-return-bar" style="width: 0%"></div>
                </div>
              </div>
              <div class="border-t pt-4">
                <div class="text-center">
                  <div class="text-3xl font-bold mb-2" id="investment-grade">-</div>
                  <p class="text-gray-600" id="investment-recommendation">-</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-8 flex justify-center gap-4">
        <button id="new-analysis-from-results" class="btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Analyze Another Property
        </button>
        <button id="save-analysis" class="btn-secondary">
          Save Analysis
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <script>
    console.log('Script starting...');

    // Global state
    let currentUser = null;
    let userProfile = null;
    let currentView = 'loading';
    let authMode = 'signin';

    // Initialize app
    async function initApp() {
      try {
        console.log('Initializing app...');
        
        // Load Firebase config
        const response = await fetch('/api/config');
        const config = await response.json();
        console.log('Config loaded:', config);
        
        // Initialize Firebase
        firebase.initializeApp(config.firebase);
        console.log('Firebase initialized');
        
        // Set up auth listener
        firebase.auth().onAuthStateChanged(async (user) => {
          console.log('Auth state changed:', user);
          if (user) {
            currentUser = user;
            userProfile = await loadUserProfile(user.uid);
            showView('dashboard');
          } else {
            currentUser = null;
            userProfile = null;
            showView('auth');
          }
        });
        
      } catch (error) {
        console.error('Init error:', error);
        alert('Failed to initialize app: ' + error.message);
      }
    }

    // Load user profile
    async function loadUserProfile(userId) {
      try {
        const db = firebase.firestore();
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
          return { id: doc.id, ...doc.data() };
        } else {
          // Create new profile
          const newProfile = {
            email: firebase.auth().currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscriptionStatus: 'trial',
            subscriptionTier: 'trial',
            monthlyAnalysisCount: 0,
            monthlyAnalysisLimit: 3,
            trialEndsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
          };
          
          await db.collection('users').doc(userId).set(newProfile);
          return { id: userId, ...newProfile };
        }
      } catch (error) {
        console.error('Profile load error:', error);
        return null;
      }
    }

    // Show specific view
    function showView(viewName) {
      console.log('Showing view:', viewName);
      
      // Hide all screens
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-screen').style.display = 'none';
      document.getElementById('property-form-screen').style.display = 'none';
      document.getElementById('results-screen').style.display = 'none';
      
      // Show target screen
      switch(viewName) {
        case 'auth':
          document.getElementById('auth-screen').style.display = 'flex';
          updateAuthMode();
          break;
        case 'dashboard':
          document.getElementById('dashboard-screen').style.display = 'block';
          updateDashboard();
          break;
        case 'property-form':
          document.getElementById('property-form-screen').style.display = 'flex';
          break;
        case 'results':
          document.getElementById('results-screen').style.display = 'block';
          break;
        default:
          document.getElementById('loading-screen').style.display = 'flex';
      }
      
      currentView = viewName;
    }

    // Update auth mode
    function updateAuthMode() {
      const isSignUp = authMode === 'signup';
      
      document.getElementById('auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
      document.getElementById('auth-subtitle').textContent = isSignUp 
        ? 'Start your 7-day free trial with 3 analyses'
        : 'Sign in to access your property analyses';
      document.getElementById('name-field').style.display = isSignUp ? 'block' : 'none';
      document.getElementById('auth-button-text').textContent = isSignUp ? 'Create Account' : 'Sign In';
      document.getElementById('auth-switch-text').textContent = isSignUp 
        ? 'Already have an account? ' 
        : "Don't have an account? ";
      document.getElementById('auth-switch').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    }

    // Update dashboard
    function updateDashboard() {
      if (currentUser) {
        document.getElementById('user-email').textContent = currentUser.email;
      }
      
      if (userProfile) {
        document.getElementById('analysis-count').textContent = 
          `${userProfile.monthlyAnalysisCount || 0} / ${userProfile.monthlyAnalysisLimit || 3}`;
        document.getElementById('subscription-tier').textContent = 
          (userProfile.subscriptionTier || 'Trial').charAt(0).toUpperCase() + (userProfile.subscriptionTier || 'trial').slice(1);
      }
    }

    // Property analysis function - now uses real API
    async function analyzeProperty(address) {
      try {
        console.log('Starting property analysis for:', address);
        
        const fullAddress = `${address.street}, ${address.city}, ${address.state}, ${address.country} ${address.postal}`.trim();
        
        // Call the real API endpoint
        const response = await fetch('/api/analyze-property', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: currentUser?.uid || null,
            propertyAddress: fullAddress,
            userEmail: currentUser?.email || null,
            userName: currentUser?.displayName || 'User',
            requestType: currentUser ? 'authenticated' : 'demo'
          })
        });
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        
        const apiResult = await response.json();
        console.log('API response:', apiResult);
        
        if (!apiResult.success) {
          throw new Error('Analysis failed: ' + (apiResult.error || 'Unknown error'));
        }
        
        const data = apiResult.data;
        
        // Transform API data to match frontend expectations
        const propertyValue = data.property_details?.estimated_value || 0;
        const monthlyRent = data.long_term_rental?.monthly_rent || 0;
        const annualRent = data.long_term_rental?.annual_revenue || monthlyRent * 12;
        
        // Get detailed expense breakdown
        const propertyTaxes = data.costs?.property_tax_annual || 0;
        const insurance = data.costs?.insurance_annual || 0;
        const maintenance = data.costs?.maintenance_annual || 0;
        const hoaMonthly = data.costs?.hoa_monthly || 0;
        const utilitiesMonthly = data.costs?.utilities_monthly || 0;
        
        const totalExpenses = propertyTaxes + insurance + maintenance + (hoaMonthly * 12) + (utilitiesMonthly * 12);
        const netAnnualIncome = annualRent - totalExpenses;
        
        // Calculate key metrics
        const capRate = propertyValue > 0 ? ((netAnnualIncome / propertyValue) * 100).toFixed(2) : '0.00';
        const cashOnCashReturn = propertyValue > 0 ? ((netAnnualIncome / (propertyValue * 0.25)) * 100).toFixed(2) : '0.00'; // Assuming 25% down
        
        // Determine investment grade
        let grade, recommendation, scoreColor;
        const capRateNum = parseFloat(capRate);
        
        if (capRateNum >= 8) {
          grade = 'A+';
          recommendation = 'Excellent investment opportunity';
          scoreColor = 'text-green-600';
        } else if (capRateNum >= 6) {
          grade = 'A';
          recommendation = 'Very good investment potential';
          scoreColor = 'text-green-500';
        } else if (capRateNum >= 4) {
          grade = 'B';
          recommendation = 'Good investment with moderate returns';
          scoreColor = 'text-blue-600';
        } else if (capRateNum >= 2) {
          grade = 'C';
          recommendation = 'Fair investment, consider other options';
          scoreColor = 'text-yellow-600';
        } else {
          grade = 'D';
          recommendation = 'Poor investment potential';
          scoreColor = 'text-red-600';
        }
        
        // Use API recommendation if available
        if (data.recommendation) {
          recommendation = data.recommendation;
        }
        
        return {
          address: fullAddress,
          date: new Date().toLocaleDateString(),
          value: propertyValue,
          monthlyRent,
          annualRent,
          propertyTaxes,
          insurance,
          maintenance,
          hoaMonthly,
          utilitiesMonthly,
          totalExpenses,
          netAnnualIncome,
          capRate,
          cashOnCashReturn,
          grade,
          recommendation,
          scoreColor,
          // Store raw API data for detailed expense breakdown
          rawApiData: data
        };
        
      } catch (error) {
        console.error('Analysis error:', error);
        throw error;
      }
    }

    // Display analysis results
    function displayResults(analysis) {
      // Property info
      document.getElementById('result-address').textContent = analysis.address;
      document.getElementById('result-date').textContent = analysis.date;
      
      // Key metrics
      document.getElementById('result-value').textContent = '$' + analysis.value.toLocaleString();
      document.getElementById('result-rent').textContent = '$' + analysis.monthlyRent.toLocaleString();
      document.getElementById('result-cap-rate').textContent = analysis.capRate + '%';
      document.getElementById('result-roi-score').textContent = analysis.grade;
      document.getElementById('result-roi-score').className = 'text-3xl font-bold ' + analysis.scoreColor;
      
      // Financial breakdown
      document.getElementById('breakdown-value').textContent = '$' + analysis.value.toLocaleString();
      document.getElementById('breakdown-income').textContent = '$' + analysis.monthlyRent.toLocaleString();
      document.getElementById('breakdown-annual-income').textContent = '$' + analysis.annualRent.toLocaleString();
      document.getElementById('breakdown-taxes').textContent = '-$' + analysis.propertyTaxes.toLocaleString();
      document.getElementById('breakdown-insurance').textContent = '-$' + analysis.insurance.toLocaleString();
      document.getElementById('breakdown-maintenance').textContent = '-$' + analysis.maintenance.toLocaleString();
      
      // Show/populate HOA and utilities if they exist
      if (analysis.hoaMonthly > 0) {
        document.getElementById('breakdown-hoa-row').style.display = 'flex';
        document.getElementById('breakdown-hoa').textContent = '-$' + (analysis.hoaMonthly * 12).toLocaleString();
      } else {
        document.getElementById('breakdown-hoa-row').style.display = 'none';
      }
      
      if (analysis.utilitiesMonthly > 0) {
        document.getElementById('breakdown-utilities-row').style.display = 'flex';
        document.getElementById('breakdown-utilities').textContent = '-$' + (analysis.utilitiesMonthly * 12).toLocaleString();
      } else {
        document.getElementById('breakdown-utilities-row').style.display = 'none';
      }
      
      document.getElementById('breakdown-net-income').textContent = '$' + analysis.netAnnualIncome.toLocaleString();
      
      // Add detailed expense breakdown functionality
      addExpenseBreakdownFunctionality(analysis);
      
      // Investment analysis
      document.getElementById('analysis-cap-rate').textContent = analysis.capRate + '%';
      document.getElementById('analysis-cash-return').textContent = analysis.cashOnCashReturn + '%';
      document.getElementById('investment-grade').textContent = analysis.grade;
      document.getElementById('investment-grade').className = 'text-3xl font-bold mb-2 ' + analysis.scoreColor;
      document.getElementById('investment-recommendation').textContent = analysis.recommendation;
      
      // Progress bars
      const capRatePercent = Math.min(parseFloat(analysis.capRate) * 10, 100);
      const cashReturnPercent = Math.min(parseFloat(analysis.cashOnCashReturn) * 5, 100);
      
      document.getElementById('cap-rate-bar').style.width = capRatePercent + '%';
      document.getElementById('cash-return-bar').style.width = cashReturnPercent + '%';
    }
    
    // Add interactive expense breakdown functionality
    function addExpenseBreakdownFunctionality(analysis) {
      // Make expense items clickable
      const expenseElements = [
        { id: 'breakdown-taxes', label: 'Property Taxes', amount: analysis.propertyTaxes },
        { id: 'breakdown-insurance', label: 'Insurance', amount: analysis.insurance },
        { id: 'breakdown-maintenance', label: 'Maintenance', amount: analysis.maintenance }
      ];
      
      // Add HOA and utilities if they exist
      if (analysis.hoaMonthly > 0) {
        expenseElements.push({ 
          id: 'breakdown-hoa', 
          label: 'HOA Fees', 
          amount: analysis.hoaMonthly * 12,
          monthly: analysis.hoaMonthly
        });
      }
      
      if (analysis.utilitiesMonthly > 0) {
        expenseElements.push({ 
          id: 'breakdown-utilities', 
          label: 'Utilities', 
          amount: analysis.utilitiesMonthly * 12,
          monthly: analysis.utilitiesMonthly
        });
      }
      
      expenseElements.forEach(expense => {
        const element = document.getElementById(expense.id);
        if (element) {
          element.style.cursor = 'pointer';
          element.style.textDecoration = 'underline';
          element.title = 'Click for detailed breakdown';
          
          element.addEventListener('click', function() {
            showExpenseDetails(expense, analysis);
          });
        }
      });
    }
    
    // Show detailed expense breakdown modal
    function showExpenseDetails(expense, analysis) {
      let detailsHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="expense-modal">
          <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">${expense.label} Breakdown</h3>
            </div>
            <div class="px-6 py-4">
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-600">Annual Amount:</span>
                  <span class="font-semibold">$${expense.amount.toLocaleString()}</span>
                </div>
      `;
      
      if (expense.monthly) {
        detailsHTML += `
                <div class="flex justify-between">
                  <span class="text-gray-600">Monthly Amount:</span>
                  <span class="font-semibold">$${expense.monthly.toLocaleString()}</span>
                </div>
        `;
      }
      
      // Add specific breakdown details based on expense type
      if (expense.label === 'Property Taxes') {
        const monthlyTax = Math.round(expense.amount / 12);
        detailsHTML += `
                <div class="border-t pt-3 mt-3">
                  <p class="text-sm text-gray-600 mb-2">Monthly Breakdown:</p>
                  <div class="flex justify-between text-sm">
                    <span>Monthly Tax Payment:</span>
                    <span>$${monthlyTax.toLocaleString()}</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>Effective Tax Rate:</span>
                    <span>${((expense.amount / analysis.value) * 100).toFixed(2)}%</span>
                  </div>
                </div>
        `;
      } else if (expense.label === 'Insurance') {
        const monthlyInsurance = Math.round(expense.amount / 12);
        detailsHTML += `
                <div class="border-t pt-3 mt-3">
                  <p class="text-sm text-gray-600 mb-2">Monthly Breakdown:</p>
                  <div class="flex justify-between text-sm">
                    <span>Monthly Premium:</span>
                    <span>$${monthlyInsurance.toLocaleString()}</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>Coverage Rate:</span>
                    <span>${((expense.amount / analysis.value) * 100).toFixed(3)}%</span>
                  </div>
                </div>
        `;
      } else if (expense.label === 'Maintenance') {
        const monthlyMaintenance = Math.round(expense.amount / 12);
        detailsHTML += `
                <div class="border-t pt-3 mt-3">
                  <p class="text-sm text-gray-600 mb-2">Monthly Breakdown:</p>
                  <div class="flex justify-between text-sm">
                    <span>Monthly Reserve:</span>
                    <span>$${monthlyMaintenance.toLocaleString()}</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>% of Property Value:</span>
                    <span>${((expense.amount / analysis.value) * 100).toFixed(2)}%</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span>% of Rental Income:</span>
                    <span>${((expense.amount / analysis.annualRent) * 100).toFixed(1)}%</span>
                  </div>
                </div>
        `;
      }
      
      detailsHTML += `
              </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
              <button onclick="closeExpenseModal()" class="btn-secondary">Close</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', detailsHTML);
    }
    
    // Close expense modal
    function closeExpenseModal() {
      const modal = document.getElementById('expense-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners...');

      // Auth form
      document.getElementById('auth-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const name = document.getElementById('name').value;
        
        try {
          if (authMode === 'signup') {
            const result = await firebase.auth().createUserWithEmailAndPassword(email, password);
            await result.user.updateProfile({ displayName: name });
          } else {
            await firebase.auth().signInWithEmailAndPassword(email, password);
          }
        } catch (error) {
          document.getElementById('auth-error').textContent = error.message;
          document.getElementById('auth-error').style.display = 'block';
        }
      });

      // Auth mode switch
      document.getElementById('auth-switch').addEventListener('click', function() {
        authMode = authMode === 'signin' ? 'signup' : 'signin';
        updateAuthMode();
        document.getElementById('auth-error').style.display = 'none';
      });

      // Sign out
      document.getElementById('sign-out-btn').addEventListener('click', function() {
        firebase.auth().signOut();
      });

      // New analysis button
      document.getElementById('new-analysis-btn').addEventListener('click', function() {
        console.log('New analysis button clicked!');
        document.getElementById('debug-text').textContent = 'Button clicked! Opening form...';
        showView('property-form');
      });

      // Back to dashboard
      document.getElementById('back-to-dashboard').addEventListener('click', function() {
        showView('dashboard');
      });

      // Property form
      document.getElementById('property-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
          // Show loading state
          submitBtn.innerHTML = `
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            Analyzing Property...
          `;
          submitBtn.disabled = true;
          
          const address = {
            street: document.getElementById('street').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            country: document.getElementById('country').value,
            postal: document.getElementById('postal').value
          };
          
          console.log('Starting analysis for address:', address);
          
          // Perform analysis
          const analysis = await analyzeProperty(address);
          
          // Display results
          displayResults(analysis);
          showView('results');
          
          // Update user profile (increment analysis count)
          if (userProfile && currentUser) {
            try {
              const db = firebase.firestore();
              await db.collection('users').doc(currentUser.uid).update({
                monthlyAnalysisCount: (userProfile.monthlyAnalysisCount || 0) + 1
              });
              userProfile.monthlyAnalysisCount = (userProfile.monthlyAnalysisCount || 0) + 1;
            } catch (error) {
              console.error('Failed to update analysis count:', error);
            }
          }
          
        } catch (error) {
          console.error('Analysis failed:', error);
          alert('Analysis failed: ' + error.message);
        } finally {
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });

      // Results screen buttons
      document.getElementById('back-to-dashboard-results').addEventListener('click', function() {
        showView('dashboard');
      });

      document.getElementById('new-analysis-from-results').addEventListener('click', function() {
        // Clear form fields
        document.getElementById('street').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('country').value = '';
        document.getElementById('postal').value = '';
        showView('property-form');
      });

      document.getElementById('save-analysis').addEventListener('click', function() {
        alert('Analysis saved to your dashboard!');
        showView('dashboard');
      });

      // Initialize the app
      initApp();
    });

    console.log('Script setup complete');
  </script>
</body>
</html>
