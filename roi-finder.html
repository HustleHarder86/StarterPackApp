<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROI Finder - InvestorProps</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 auto;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    /* Form styles */
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Card styles */
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Loading Screen -->
  <div id="loading-screen" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading ROI Finder...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2" id="auth-title">Welcome Back</h1>
        <p class="text-gray-600" id="auth-subtitle">Sign in to access your property analyses</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="auth-form">
          <div class="space-y-6">
            <div id="name-field" style="display: none;">
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input type="text" id="name" class="form-input" placeholder="John Doe" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="email" class="form-input" placeholder="john@example.com" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input type="password" id="password" class="form-input" placeholder="••••••••" required minlength="6" />
            </div>

            <div id="auth-error" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm" style="display: none;"></div>

            <button type="submit" class="btn-primary w-full">
              <span id="auth-button-text">Sign In</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <p class="text-gray-600">
            <span id="auth-switch-text">Don't have an account? </span>
            <button id="auth-switch" class="text-blue-600 hover:text-blue-800 font-semibold">Sign Up</button>
          </p>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <a href="index.html" class="text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1">
            ← Back to Homepage
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard-screen" class="min-h-screen bg-gray-50" style="display: none;">
    <!-- Header -->
    <div class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">InvestorProps</h1>
            <span class="text-sm text-gray-500">Dashboard</span>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm text-gray-700" id="user-email"></span>
            <button id="sign-out-btn" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
          <p class="text-sm text-gray-600">Analyses Used</p>
          <p class="text-2xl font-bold text-gray-900" id="analysis-count">0 / 3</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Subscription</p>
          <p class="text-2xl font-bold text-gray-900" id="subscription-tier">Trial</p>
        </div>
        <div class="stat-card">
          <p class="text-sm text-gray-600">Total Analyses</p>
          <p class="text-2xl font-bold text-gray-900" id="total-analyses">0</p>
        </div>
      </div>

      <!-- New Analysis Button -->
      <div class="text-center mb-8">
        <button id="new-analysis-btn" class="btn-primary">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          New Property Analysis
        </button>
        <p class="text-xs text-gray-500 mt-2" id="debug-text">Debug: showNewAnalysis = false</p>
        
        <!-- Test Button for Debugging -->
        <button id="test-click-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mt-2" style="display: block; margin: 10px auto;">
          Test Click (Remove this after testing)
        </button>
      </div>

      <!-- Recent Analyses -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Recent Analyses</h2>
        </div>
        <div id="analyses-list" class="divide-y divide-gray-200">
          <div class="px-6 py-12 text-center text-gray-500">
            No analyses yet. Click "New Property Analysis" to get started!
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Input Form -->
  <div id="property-form-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6" style="display: none;">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Property ROI Analyzer</h1>
        <p class="text-gray-600">Get AI-powered investment analysis for any property worldwide</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <form id="property-form">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
              <input type="text" id="street" class="form-input" placeholder="123 Main Street" required />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                <input type="text" id="city" class="form-input" placeholder="Toronto" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">State/Province *</label>
                <input type="text" id="state" class="form-input" placeholder="Ontario" required />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                <input type="text" id="country" class="form-input" placeholder="Canada" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Postal/Zip Code</label>
                <input type="text" id="postal" class="form-input" placeholder="M5V 3A8" />
              </div>
            </div>

            <button type="submit" class="btn-primary w-full">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Analyze Property
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between">
          <button id="back-to-dashboard" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
            ← Back to Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <script>
    console.log('Script starting...');

    // Global state
    let currentUser = null;
    let userProfile = null;
    let currentView = 'loading';
    let authMode = 'signin';

    // Initialize app
    async function initApp() {
      try {
        console.log('Initializing app...');
        
        // Load Firebase config
        const response = await fetch('/api/config');
        const config = await response.json();
        console.log('Config loaded:', config);
        
        // Initialize Firebase
        firebase.initializeApp(config.firebase);
        console.log('Firebase initialized');
        
        // Set up auth listener
        firebase.auth().onAuthStateChanged(async (user) => {
          console.log('Auth state changed:', user);
          if (user) {
            currentUser = user;
            userProfile = await loadUserProfile(user.uid);
            showView('dashboard');
          } else {
            currentUser = null;
            userProfile = null;
            showView('auth');
          }
        });
        
      } catch (error) {
        console.error('Init error:', error);
        alert('Failed to initialize app: ' + error.message);
      }
    }

    // Load user profile
    async function loadUserProfile(userId) {
      try {
        const db = firebase.firestore();
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
          return { id: doc.id, ...doc.data() };
        } else {
          // Create new profile
          const newProfile = {
            email: firebase.auth().currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            subscriptionStatus: 'trial',
            subscriptionTier: 'trial',
            monthlyAnalysisCount: 0,
            monthlyAnalysisLimit: 3,
            trialEndsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
          };
          
          await db.collection('users').doc(userId).set(newProfile);
          return { id: userId, ...newProfile };
        }
      } catch (error) {
        console.error('Profile load error:', error);
        return null;
      }
    }

    // Show specific view
    function showView(viewName) {
      console.log('showView called with:', viewName);
      console.log('Previous view was:', currentView);
      
      // Check if elements exist
      const screens = ['loading-screen', 'auth-screen', 'dashboard-screen', 'property-form-screen'];
      screens.forEach(screenId => {
        const element = document.getElementById(screenId);
        if (!element) {
          console.error('Screen element not found:', screenId);
        }
      });
      
      // Hide all screens
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-screen').style.display = 'none';
      document.getElementById('property-form-screen').style.display = 'none';
      
      // Show target screen
      switch(viewName) {
        case 'auth':
          console.log('Switching to auth screen');
          document.getElementById('auth-screen').style.display = 'flex';
          updateAuthMode();
          break;
        case 'dashboard':
          console.log('Switching to dashboard screen');
          document.getElementById('dashboard-screen').style.display = 'block';
          updateDashboard();
          break;
        case 'property-form':
          console.log('Switching to property-form screen');
          document.getElementById('property-form-screen').style.display = 'flex';
          break;
        default:
          console.log('Switching to loading screen (default)');
          document.getElementById('loading-screen').style.display = 'flex';
      }
      
      currentView = viewName;
      console.log('View switch complete. New view:', currentView);
    }

    // Update auth mode
    function updateAuthMode() {
      const isSignUp = authMode === 'signup';
      
      document.getElementById('auth-title').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
      document.getElementById('auth-subtitle').textContent = isSignUp 
        ? 'Start your 7-day free trial with 3 analyses'
        : 'Sign in to access your property analyses';
      document.getElementById('name-field').style.display = isSignUp ? 'block' : 'none';
      document.getElementById('auth-button-text').textContent = isSignUp ? 'Create Account' : 'Sign In';
      document.getElementById('auth-switch-text').textContent = isSignUp 
        ? 'Already have an account? ' 
        : "Don't have an account? ";
      document.getElementById('auth-switch').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    }

    // Update dashboard
    function updateDashboard() {
      if (currentUser) {
        document.getElementById('user-email').textContent = currentUser.email;
      }
      
      if (userProfile) {
        document.getElementById('analysis-count').textContent = 
          `${userProfile.monthlyAnalysisCount || 0} / ${userProfile.monthlyAnalysisLimit || 3}`;
        document.getElementById('subscription-tier').textContent = 
          (userProfile.subscriptionTier || 'Trial').charAt(0).toUpperCase() + (userProfile.subscriptionTier || 'trial').slice(1);
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners...');
      
      // Debug: Check if critical elements exist
      const criticalElements = [
        'new-analysis-btn',
        'test-click-btn',
        'debug-text',
        'dashboard-screen',
        'property-form-screen',
        'auth-screen',
        'loading-screen'
      ];
      
      criticalElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          console.log(`✓ Element found: ${id}`);
        } else {
          console.error(`✗ Element missing: ${id}`);
        }
      });

      // Auth form
      document.getElementById('auth-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const name = document.getElementById('name').value;
        
        try {
          if (authMode === 'signup') {
            const result = await firebase.auth().createUserWithEmailAndPassword(email, password);
            await result.user.updateProfile({ displayName: name });
          } else {
            await firebase.auth().signInWithEmailAndPassword(email, password);
          }
        } catch (error) {
          document.getElementById('auth-error').textContent = error.message;
          document.getElementById('auth-error').style.display = 'block';
        }
      });

      // Auth mode switch
      document.getElementById('auth-switch').addEventListener('click', function() {
        authMode = authMode === 'signin' ? 'signup' : 'signin';
        updateAuthMode();
        document.getElementById('auth-error').style.display = 'none';
      });

      // Sign out
      document.getElementById('sign-out-btn').addEventListener('click', function() {
        firebase.auth().signOut();
      });

      // New analysis button
      document.getElementById('new-analysis-btn').addEventListener('click', function() {
        console.log('New analysis button clicked!');
        console.log('Current view:', currentView);
        console.log('Current user:', currentUser);
        document.getElementById('debug-text').textContent = 'Debug: showNewAnalysis = true (button clicked!)';
        
        // Add visual feedback
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 100);
        
        showView('property-form');
      });

      // Test button for debugging
      document.getElementById('test-click-btn').addEventListener('click', function() {
        console.log('Test button clicked!');
        document.getElementById('debug-text').textContent = 'Debug: Test button works! Event listeners are active.';
        alert('Test button clicked! This confirms JavaScript is working.');
        
        // Also test the showView function
        setTimeout(() => {
          if (confirm('Test the showView function by showing property form?')) {
            showView('property-form');
          }
        }, 1000);
      });

      // Back to dashboard
      document.getElementById('back-to-dashboard').addEventListener('click', function() {
        showView('dashboard');
      });

      // Property form
      document.getElementById('property-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const street = document.getElementById('street').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const country = document.getElementById('country').value;
        const postal = document.getElementById('postal').value;
        
        const fullAddress = `${street}, ${city}, ${state}, ${country} ${postal}`.trim();
        
        alert(`Analysis would start for: ${fullAddress}\n\nThis would call the API and show results.`);
        
        // For now, just go back to dashboard
        showView('dashboard');
      });

      // Initialize the app
      initApp();
    });

    console.log('Script setup complete');
  </script>
</body>
</html>
