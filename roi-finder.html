<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROI Finder - InvestorProps</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Icon styles */
    .icon {
      display: inline-block;
      width: 1em;
      height: 1em;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Charts */
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 250px;
      padding: 20px;
      gap: 20px;
    }
    
    .bar-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .bars {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      height: 200px;
    }
    
    .bar {
      width: 40px;
      background: #3B82F6;
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .bar:hover {
      opacity: 0.8;
    }
    
    .bar.profit {
      background: #10B981;
    }
    
    .bar-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      white-space: nowrap;
      font-weight: 600;
    }
    
    .bar-type {
      font-weight: 600;
      color: #374151;
    }
    
    /* Pie chart */
    .pie-chart {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      position: relative;
      margin: 20px auto;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .pie-chart:hover {
      transform: scale(1.05);
    }
    
    .pie-slice {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    
    .legend-item:hover {
      opacity: 0.8;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Input styles */
    .mortgage-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .mortgage-input:focus {
      outline: none;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
      <div style="text-align: center;">
        <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #16a34a; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="color: #6b7280; margin-top: 20px; font-family: sans-serif;">Loading ROI Finder...</p>
      </div>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;
    
    // Icons Component
    const Icons = {
      Calculator: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <rect x="4" y="2" width="16" height="20" rx="2" />
          <line x1="8" y1="6" x2="16" y2="6" />
          <line x1="8" y1="10" x2="16" y2="10" />
          <line x1="8" y1="14" x2="10" y2="14" />
          <line x1="14" y1="14" x2="16" y2="14" />
          <line x1="8" y1="18" x2="10" y2="18" />
          <line x1="14" y1="18" x2="16" y2="18" />
        </svg>
      ),
      User: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
      ),
      Mail: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <rect x="2" y="4" width="20" height="16" rx="2" />
          <path d="m22 7-10 5L2 7" />
        </svg>
      ),
      MapPin: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
          <circle cx="12" cy="10" r="3" />
        </svg>
      ),
      Check: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <polyline points="20 6 9 17 4 12" />
        </svg>
      ),
      ArrowRight: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <line x1="5" y1="12" x2="19" y2="12" />
          <polyline points="12 5 19 12 12 19" />
        </svg>
      ),
      Clock: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      ),
      Home: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <polyline points="9 22 9 12 15 12 15 22" />
        </svg>
      ),
      DollarSign: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <line x1="12" y1="1" x2="12" y2="23" />
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      ),
      TrendingUp: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
          <polyline points="17 6 23 6 23 12" />
        </svg>
      ),
      Calendar: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      ),
      AlertCircle: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
      ),
      LogOut: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" y1="12" x2="9" y2="12" />
        </svg>
      ),
      Key: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 2.25-2.25L21 2l-3.25 3.25m-2.25 2.25L19 11" />
        </svg>
      ),
      BarChart: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <line x1="12" y1="20" x2="12" y2="10" />
          <line x1="18" y1="20" x2="18" y2="4" />
          <line x1="6" y1="20" x2="6" y2="16" />
        </svg>
      ),
      Globe: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
        </svg>
      ),
      FileText: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
          <polyline points="10 9 9 9 8 9" />
        </svg>
      ),
      Info: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="16" x2="12" y2="12" />
          <line x1="12" y1="8" x2="12.01" y2="8" />
        </svg>
      ),
      X: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      ),
      Receipt: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1z" />
          <path d="M8 7h8M8 11h8M8 15h4" />
        </svg>
      ),
      Building: () => (
        <svg className="icon" viewBox="0 0 24 24">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2" />
          <path d="M9 22v-4h6v4M8 6h.01M12 6h.01M16 6h.01M8 10h.01M12 10h.01M16 10h.01M8 14h.01M12 14h.01M16 14h.01" />
        </svg>
      )
    };

    // Main App Component
    const ROIFinderApp = () => {
      const [currentView, setCurrentView] = useState('loading');
      const [user, setUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [authMode, setAuthMode] = useState('signin');
      const [loading, setLoading] = useState(true);
      const [analysisData, setAnalysisData] = useState(null);
      const [userAnalyses, setUserAnalyses] = useState([]);
      const [error, setError] = useState('');

      // Initialize Firebase
      useEffect(() => {
        const initFirebase = async () => {
          try {
            // Load config from API
            const response = await fetch('/api/config');
            const config = await response.json();
            
            // Initialize Firebase
            firebase.initializeApp(config.firebase);
            
            // Set up auth listener
            firebase.auth().onAuthStateChanged(async (user) => {
              if (user) {
                // Load user profile
                const profile = await loadUserProfile(user.uid);
                setUser(user);
                setUserProfile(profile);
                setCurrentView('dashboard');
              } else {
                setUser(null);
                setUserProfile(null);
                setCurrentView('auth');
              }
              setLoading(false);
            });
          } catch (error) {
            console.error('Firebase init error:', error);
            setError('Failed to initialize app');
            setLoading(false);
          }
        };

        initFirebase();
      }, []);

      // Load user profile
      const loadUserProfile = async (userId) => {
        try {
          const db = firebase.firestore();
          const doc = await db.collection('users').doc(userId).get();
          
          if (doc.exists) {
            return { id: doc.id, ...doc.data() };
          } else {
            // Create new profile
            const newProfile = {
              email: firebase.auth().currentUser.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              subscriptionStatus: 'trial',
              subscriptionTier: 'trial',
              monthlyAnalysisCount: 0,
              monthlyAnalysisLimit: 3,
              trialEndsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
            };
            
            await db.collection('users').doc(userId).set(newProfile);
            return { id: userId, ...newProfile };
          }
        } catch (error) {
          console.error('Profile load error:', error);
          return null;
        }
      };

      // Load user analyses
      const loadUserAnalyses = async () => {
        if (!user) return;
        
        try {
          const db = firebase.firestore();
          const snapshot = await db.collection('analyses')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get();
          
          const analyses = [];
          snapshot.forEach(doc => {
            analyses.push({ id: doc.id, ...doc.data() });
          });
          
          setUserAnalyses(analyses);
        } catch (error) {
          console.error('Load analyses error:', error);
        }
      };

      // Authentication Component
      const AuthScreen = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [name, setName] = useState('');
        const [authError, setAuthError] = useState('');
        const [authLoading, setAuthLoading] = useState(false);

        const handleSignUp = async (e) => {
          e.preventDefault();
          setAuthLoading(true);
          setAuthError('');

          try {
            const result = await firebase.auth().createUserWithEmailAndPassword(email, password);
            
            // Update display name
            await result.user.updateProfile({ displayName: name });
            
            // Create user profile
            const db = firebase.firestore();
            await db.collection('users').doc(result.user.uid).set({
              email,
              displayName: name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              subscriptionStatus: 'trial',
              subscriptionTier: 'trial',
              monthlyAnalysisCount: 0,
              monthlyAnalysisLimit: 3,
              trialEndsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
            });
          } catch (error) {
            setAuthError(error.message);
          } finally {
            setAuthLoading(false);
          }
        };

        const handleSignIn = async (e) => {
          e.preventDefault();
          setAuthLoading(true);
          setAuthError('');

          try {
            await firebase.auth().signInWithEmailAndPassword(email, password);
          } catch (error) {
            setAuthError(error.message);
          } finally {
            setAuthLoading(false);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6">
            <div className="max-w-md w-full">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
                  <div className="w-8 h-8 text-white">
                    <Icons.Key />
                  </div>
                </div>
                <h1 className="text-3xl font-bold text-gray-900 mb-2">
                  {authMode === 'signin' ? 'Welcome Back' : 'Create Account'}
                </h1>
                <p className="text-gray-600">
                  {authMode === 'signin' 
                    ? 'Sign in to access your property analyses' 
                    : 'Start your 7-day free trial with 3 analyses'}
                </p>
              </div>

              <div className="bg-white rounded-2xl shadow-xl p-8">
                <form onSubmit={authMode === 'signin' ? handleSignIn : handleSignUp}>
                  <div className="space-y-6">
                    {authMode === 'signup' && (
                      <div>
                        <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                          <div className="w-4 h-4 mr-2"><Icons.User /></div>
                          Full Name
                        </label>
                        <input
                          type="text"
                          required
                          value={name}
                          onChange={(e) => setName(e.target.value)}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="John Doe"
                        />
                      </div>
                    )}

                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.Mail /></div>
                        Email Address
                      </label>
                      <input
                        type="email"
                        required
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="john@example.com"
                      />
                    </div>

                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.Key /></div>
                        Password
                      </label>
                      <input
                        type="password"
                        required
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="••••••••"
                        minLength={6}
                      />
                    </div>

                    {authError && (
                      <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                        {authError}
                      </div>
                    )}

                    <button
                      type="submit"
                      disabled={authLoading}
                      className="w-full bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50"
                    >
                      {authLoading ? (
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                      ) : (
                        <>
                          {authMode === 'signin' ? 'Sign In' : 'Create Account'}
                          <div className="w-5 h-5"><Icons.ArrowRight /></div>
                        </>
                      )}
                    </button>
                  </div>
                </form>

                <div className="mt-6 text-center">
                  <p className="text-gray-600">
                    {authMode === 'signin' ? "Don't have an account? " : "Already have an account? "}
                    <button
                      onClick={() => setAuthMode(authMode === 'signin' ? 'signup' : 'signin')}
                      className="text-blue-600 hover:text-blue-800 font-semibold"
                    >
                      {authMode === 'signin' ? 'Sign Up' : 'Sign In'}
                    </button>
                  </p>
                </div>

                <div className="mt-6 pt-6 border-t border-gray-200">
                  <a href="index.html" className="text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1">
                    ← Back to Homepage
                  </a>
                </div>
              </div>
            </div>
          </div>
        );
      };

 // Dashboard Component
const Dashboard = () => {
  const [showNewAnalysis, setShowNewAnalysis] = useState(false);

  useEffect(() => {
    loadUserAnalyses();
  }, []);

  const handleNewAnalysis = () => {
    console.log('New Analysis button clicked');
    setShowNewAnalysis(true);
  };

  if (showNewAnalysis) {
    console.log('Showing PropertyInputForm');
    return <PropertyInputForm onBack={() => {
      console.log('Going back to dashboard');
      setShowNewAnalysis(false);
    }} />;
  }
        return (
          <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <div className="bg-white shadow-sm">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center py-4">
                  <div className="flex items-center gap-4">
                    <h1 className="text-2xl font-bold text-gray-900">InvestorProps</h1>
                    <span className="text-sm text-gray-500">Dashboard</span>
                  </div>
                  <div className="flex items-center gap-4">
                    <span className="text-sm text-gray-700">{user?.email}</span>
                    <button
                      onClick={() => firebase.auth().signOut()}
                      className="flex items-center gap-2 text-gray-600 hover:text-gray-900"
                    >
                      <div className="w-5 h-5"><Icons.LogOut /></div>
                      Sign Out
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Main Content */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
              {/* Stats */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white rounded-lg shadow p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600">Analyses Used</p>
                      <p className="text-2xl font-bold text-gray-900">
                        {userProfile?.monthlyAnalysisCount || 0} / {userProfile?.monthlyAnalysisLimit || 3}
                      </p>
                    </div>
                    <div className="p-3 bg-blue-100 rounded-lg">
                      <div className="w-6 h-6 text-blue-600"><Icons.BarChart /></div>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600">Subscription</p>
                      <p className="text-2xl font-bold text-gray-900 capitalize">
                        {userProfile?.subscriptionTier || 'Trial'}
                      </p>
                    </div>
                    <div className="p-3 bg-green-100 rounded-lg">
                      <div className="w-6 h-6 text-green-600"><Icons.Check /></div>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-600">Total Analyses</p>
                      <p className="text-2xl font-bold text-gray-900">{userAnalyses.length}</p>
                    </div>
                    <div className="p-3 bg-purple-100 rounded-lg">
                      <div className="w-6 h-6 text-purple-600"><Icons.Home /></div>
                    </div>
                  </div>
                </div>
              </div>

              {/* New Analysis Button */}
              <div className="text-center mb-8">
                <button
                  onClick={() => setShowNewAnalysis(true)}
                  className="bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white font-semibold py-4 px-8 rounded-lg transition-all duration-300 flex items-center gap-3 mx-auto"
                >
                  <div className="w-6 h-6"><Icons.Calculator /></div>
                  New Property Analysis
                </button>
              </div>

              {/* Recent Analyses */}
              <div className="bg-white rounded-lg shadow">
                <div className="px-6 py-4 border-b border-gray-200">
                  <h2 className="text-lg font-semibold text-gray-900">Recent Analyses</h2>
                </div>
                <div className="divide-y divide-gray-200">
                  {userAnalyses.length === 0 ? (
                    <div className="px-6 py-12 text-center text-gray-500">
                      No analyses yet. Click "New Property Analysis" to get started!
                    </div>
                  ) : (
                    userAnalyses.map((analysis) => (
                      <div key={analysis.id} className="px-6 py-4 hover:bg-gray-50 cursor-pointer"
                           onClick={() => {
                             setAnalysisData(analysis);
                             setCurrentView('results');
                           }}>
                        <div className="flex justify-between items-start">
                          <div>
                            <h3 className="font-medium text-gray-900">
                              {analysis.property_details?.address || analysis.propertyAddress || analysis.property_address}
                            </h3>
                            <p className="text-sm text-gray-600 mt-1">
                              ROI: {analysis.roi_percentage}% • 
                              {analysis.recommendation?.includes('Short-term') ? ' Short-term' : ' Long-term'} rental recommended
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-gray-500">
                              {new Date(analysis.createdAt?.toDate?.() || analysis.analysis_timestamp).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Property Input Form Component
      const PropertyInputForm = ({ onBack }) => {
        const [propertyData, setPropertyData] = useState({
          street: '',
          city: '',
          stateProvince: '',
          country: '',
          postalCode: ''
        });
        const [submitting, setSubmitting] = useState(false);

        const handleInputChange = useCallback((field, value) => {
          setPropertyData(prev => ({
            ...prev,
            [field]: value
          }));
        }, []);

        const submitForAnalysis = async () => {
          // Validate all fields
          if (!propertyData.street || !propertyData.city || !propertyData.stateProvince || !propertyData.country) {
            alert('Please fill in all required fields');
            return;
          }

          // Check analysis limit
          if (userProfile.monthlyAnalysisCount >= userProfile.monthlyAnalysisLimit) {
            alert(`You've reached your monthly limit of ${userProfile.monthlyAnalysisLimit} analyses. Please upgrade your plan.`);
            return;
          }

          setSubmitting(true);
          setCurrentView('processing');

          try {
            // Construct full address
            const fullAddress = `${propertyData.street}, ${propertyData.city}, ${propertyData.stateProvince}, ${propertyData.country} ${propertyData.postalCode}`.trim();

            // Call the real API
            const response = await fetch('/api/analyze-property', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: user.uid,
                propertyAddress: fullAddress,
                userEmail: user.email,
                userName: user.displayName || user.email,
                requestType: 'authenticated'
              })
            });

            if (!response.ok) {
              throw new Error('Analysis failed');
            }

            const result = await response.json();
            
            // Update analysis count
            const db = firebase.firestore();
            await db.collection('users').doc(user.uid).update({
              monthlyAnalysisCount: firebase.firestore.FieldValue.increment(1)
            });

            // Set the analysis data and show results
            setAnalysisData(result.data);
            setCurrentView('results');
          } catch (error) {
            console.error('Analysis error:', error);
            alert('Analysis failed. Please try again.');
            setCurrentView('dashboard');
          } finally {
            setSubmitting(false);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6">
            <div className="max-w-md w-full">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-4">
                  <div className="w-8 h-8 text-white">
                    <Icons.Calculator />
                  </div>
                </div>
                <h1 className="text-3xl font-bold text-gray-900 mb-2">Property ROI Analyzer</h1>
                <p className="text-gray-600">Get AI-powered investment analysis for any property worldwide</p>
              </div>

              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="space-y-6">
                  <div>
                    <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                      <div className="w-4 h-4 mr-2"><Icons.MapPin /></div>
                      Street Address *
                    </label>
                    <input
                      type="text"
                      placeholder="123 Main Street"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      value={propertyData.street}
                      onChange={(e) => handleInputChange('street', e.target.value)}
                      required
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.MapPin /></div>
                        City *
                      </label>
                      <input
                        type="text"
                        placeholder="Toronto"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value={propertyData.city}
                        onChange={(e) => handleInputChange('city', e.target.value)}
                        required
                      />
                    </div>

                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.MapPin /></div>
                        State/Province *
                      </label>
                      <input
                        type="text"
                        placeholder="Ontario"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value={propertyData.stateProvince}
                        onChange={(e) => handleInputChange('stateProvince', e.target.value)}
                        required
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.Globe /></div>
                        Country *
                      </label>
                      <input
                        type="text"
                        placeholder="Canada"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value={propertyData.country}
                        onChange={(e) => handleInputChange('country', e.target.value)}
                        required
                      />
                    </div>

                    <div>
                      <label className="flex items-center text-sm font-medium text-gray-700 mb-2">
                        <div className="w-4 h-4 mr-2"><Icons.MapPin /></div>
                        Postal/Zip Code
                      </label>
                      <input
                        type="text"
                        placeholder="M5V 3A8"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value={propertyData.postalCode}
                        onChange={(e) => handleInputChange('postalCode', e.target.value)}
                      />
                    </div>
                  </div>

                  <button
                    onClick={submitForAnalysis}
                    disabled={submitting}
                    className="w-full bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50"
                  >
                    {submitting ? (
                      <>
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        Processing...
                      </>
                    ) : (
                      <>
                        <div className="w-5 h-5"><Icons.Calculator /></div>
                        Analyze Property
                        <div className="w-5 h-5"><Icons.ArrowRight /></div>
                      </>
                    )}
                  </button>
                </div>

                <div className="mt-6 pt-6 border-t border-gray-200">
                  <h3 className="font-semibold text-gray-900 mb-3">Analysis includes:</h3>
                  <div className="space-y-2">
                    <div className="flex items-center text-sm text-gray-600">
                      <div className="w-4 h-4 text-green-500 mr-2"><Icons.Check /></div>
                      Current market value & comparables
                    </div>
                    <div className="flex items-center text-sm text-gray-600">
                      <div className="w-4 h-4 text-green-500 mr-2"><Icons.Check /></div>
                      Short-term (Airbnb) vs long-term rental analysis
                    </div>
                    <div className="flex items-center text-sm text-gray-600">
                      <div className="w-4 h-4 text-green-500 mr-2"><Icons.Check /></div>
                      All costs: taxes, insurance, maintenance, HOA
                    </div>
                    <div className="flex items-center text-sm text-gray-600">
                      <div className="w-4 h-4 text-green-500 mr-2"><Icons.Check /></div>
                      ROI calculations and investment recommendations
                    </div>
                  </div>
                </div>

                <div className="mt-6 pt-4 border-t border-gray-200 flex justify-between">
                  <button 
                    onClick={onBack}
                    className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1"
                  >
                    ← Back to Dashboard
                  </button>
                  <span className="text-xs text-gray-500">
                    {userProfile?.monthlyAnalysisCount || 0}/{userProfile?.monthlyAnalysisLimit || 3} analyses used
                  </span>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Processing Screen
      const ProcessingScreen = () => (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-6">
          <div className="max-w-md w-full text-center">
            <div className="bg-white rounded-2xl shadow-xl p-8">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-green-500 rounded-full mb-6">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
              </div>
              
              <h2 className="text-2xl font-bold text-gray-900 mb-4">Analyzing Your Property</h2>
              <p className="text-gray-600 mb-6">
                Our AI is performing comprehensive market research and analysis...
              </p>
              
              <div className="space-y-3 text-left">
                <div className="flex items-center text-sm text-gray-600">
                  <div className="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                  Researching current market values and comparable sales
                </div>
                <div className="flex items-center text-sm text-gray-600">
                  <div className="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                  Analyzing local rental market and regulations
                </div>
                <div className="flex items-center text-sm text-gray-600">
                  <div className="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                  Calculating property taxes, insurance, and costs
                </div>
                <div className="flex items-center text-sm text-gray-600">
                  <div className="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                  Comparing short-term vs long-term rental potential
                </div>
                <div className="flex items-center text-sm text-gray-600">
                  <div className="w-2 h-2 bg-green-500 rounded-full mr-3 animate-pulse"></div>
                  Generating personalized investment recommendations
                </div>
              </div>
              
              <div className="mt-6 pt-6 border-t border-gray-200">
                <div className="flex items-center justify-center text-sm text-gray-500">
                  <div className="w-4 h-4 mr-2"><Icons.Clock /></div>
                  This typically takes 30-60 seconds
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      // Results Dashboard
      const InvestmentDashboard = ({ propertyData }) => {
        const [showCostModal, setShowCostModal] = useState(false);
        const [selectedCostItem, setSelectedCostItem] = useState(null);
        const [monthlyMortgage, setMonthlyMortgage] = useState(0);
        const [showMortgageInput, setShowMortgageInput] = useState(false);
        const mortgageInputRef = useRef(null);

        const formatCurrency = (value) => {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(value);
        };

        const totalAnnualCosts = propertyData.costs.property_tax_annual + 
          propertyData.costs.insurance_annual + 
          propertyData.costs.maintenance_annual + 
          (propertyData.costs.hoa_monthly * 12) + 
          (propertyData.costs.utilities_monthly * 12);

        const costBreakdown = [
          { name: 'Property Tax', value: propertyData.costs.property_tax_annual, color: '#3B82F6', monthly: propertyData.costs.property_tax_annual / 12 },
          { name: 'HOA Fees', value: propertyData.costs.hoa_monthly * 12, color: '#10B981', monthly: propertyData.costs.hoa_monthly },
          { name: 'Utilities', value: propertyData.costs.utilities_monthly * 12, color: '#F59E0B', monthly: propertyData.costs.utilities_monthly },
          { name: 'Insurance', value: propertyData.costs.insurance_annual, color: '#EF4444', monthly: propertyData.costs.insurance_annual / 12 },
          { name: 'Maintenance', value: propertyData.costs.maintenance_annual, color: '#8B5CF6', monthly: propertyData.costs.maintenance_annual / 12 }
        ];

        const handleCostClick = (item) => {
          setSelectedCostItem(item);
          setShowCostModal(true);
        };

        const calculateCashFlow = (monthlyIncome) => {
          const monthlyCosts = totalAnnualCosts / 12;
          return monthlyIncome - monthlyCosts - monthlyMortgage;
        };

        const MetricCard = ({ icon: Icon, title, value, subtitle, trend, trendValue }) => (
          <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <div className="flex items-center justify-between mb-4">
              <div className="p-3 bg-blue-100 rounded-lg">
                <div className="w-6 h-6 text-blue-600"><Icon /></div>
              </div>
              {trend && (
                <div className={`flex items-center ${trend === 'up' ? 'text-green-600' : 'text-red-600'}`}>
                  <div className="w-4 h-4 mr-1"><Icons.TrendingUp /></div>
                  <span className="text-sm font-medium">{trendValue}%</span>
                </div>
              )}
            </div>
            <h3 className="text-gray-600 text-sm font-medium">{title}</h3>
            <p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>
            {subtitle && <p className="text-gray-500 text-xs mt-1">{subtitle}</p>}
          </div>
        );

        // Enhanced Rental Income Display
        const RentalIncomeCard = ({ type, data }) => {
          const monthlyIncome = type === 'short' 
            ? (data.daily_rate * 365 * (data.occupancy_rate / 100)) / 12
            : data.monthly_rent;
          
          const cashFlow = calculateCashFlow(monthlyIncome);
          
          return (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-bold text-gray-900 mb-4">
                {type === 'short' ? 'Short-Term Rental' : 'Long-Term Rental'}
              </h3>
              
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600">Monthly Income</p>
                    <p className="text-xl font-bold text-gray-900">{formatCurrency(monthlyIncome)}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Annual Income</p>
                    <p className="text-xl font-bold text-gray-900">{formatCurrency(data.annual_revenue)}</p>
                  </div>
                </div>
                
                {type === 'short' && (
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-sm text-gray-600">Daily Rate</p>
                      <p className="text-lg font-semibold">{formatCurrency(data.daily_rate)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-600">Occupancy Rate</p>
                      <p className="text-lg font-semibold">{data.occupancy_rate}%</p>
                    </div>
                  </div>
                )}
                
                <div className="pt-4 border-t border-gray-200">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600">Monthly Cash Flow</span>
                    <span className={`text-lg font-bold ${cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {formatCurrency(cashFlow)}
                    </span>
                  </div>
                  {monthlyMortgage > 0 && (
                    <p className="text-xs text-gray-500 mt-1">
                      After ${monthlyMortgage}/mo mortgage
                    </p>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // Interactive pie chart component
        const InteractivePieChart = () => {
          const [hoveredSlice, setHoveredSlice] = useState(null);
          const total = costBreakdown.reduce((sum, item) => sum + item.value, 0);
          let currentAngle = 0;

          return (
            <div className="relative">
              <div 
                className="pie-chart" 
                style={{ 
                  background: `conic-gradient(${costBreakdown.map(item => {
                    const startAngle = currentAngle;
                    const angle = (item.value / total) * 360;
                    currentAngle += angle;
                    return `${item.color} ${startAngle}deg ${currentAngle}deg`;
                  }).join(', ')})` 
                }}
                onClick={() => setShowCostModal(true)}
              />
              
              <div className="chart-legend">
                {costBreakdown.map((item, index) => (
                  <div 
                    key={index} 
                    className="legend-item"
                    onClick={() => handleCostClick(item)}
                    onMouseEnter={() => setHoveredSlice(item)}
                    onMouseLeave={() => setHoveredSlice(null)}
                  >
                    <div className="legend-color" style={{ backgroundColor: item.color }}></div>
                    <span>{item.name} ({((item.value / total) * 100).toFixed(0)}%)</span>
                  </div>
                ))}
              </div>
              
              {hoveredSlice && (
                <div className="tooltip" style={{ top: '-50px', left: '50%', transform: 'translateX(-50%)' }}>
                  {formatCurrency(hoveredSlice.value)} annually
                </div>
              )}
            </div>
          );
        };

        // Licensing Requirements Section
        const LicensingSection = () => (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div className="flex items-start gap-4">
              <div className="p-3 bg-yellow-100 rounded-lg">
                <div className="w-6 h-6 text-yellow-600"><Icons.FileText /></div>
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Licensing & Regulations</h3>
                
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Short-Term Rental Requirements</h4>
                    <ul className="space-y-2 text-sm text-gray-600">
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-yellow-500 mt-0.5"><Icons.AlertCircle /></div>
                        <span>Business license required in most municipalities</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-yellow-500 mt-0.5"><Icons.AlertCircle /></div>
                        <span>Platform registration (Airbnb permit) may be required</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-yellow-500 mt-0.5"><Icons.AlertCircle /></div>
                        <span>Some areas have rental day limits (e.g., 180 days/year)</span>
                      </li>
                      {propertyData.property_details.property_type === 'Condo' && (
                        <li className="flex items-start gap-2">
                          <div className="w-4 h-4 text-red-500 mt-0.5"><Icons.AlertCircle /></div>
                          <span className="text-red-600 font-semibold">
                            Condo board approval required - verify STR policy
                          </span>
                        </li>
                      )}
                    </ul>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Long-Term Rental Requirements</h4>
                    <ul className="space-y-2 text-sm text-gray-600">
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-green-500 mt-0.5"><Icons.Check /></div>
                        <span>Generally fewer restrictions than STR</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-green-500 mt-0.5"><Icons.Check /></div>
                        <span>Standard landlord-tenant laws apply</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <div className="w-4 h-4 text-green-500 mt-0.5"><Icons.Check /></div>
                        <span>Rental property registration may be required</span>
                      </li>
                    </ul>
                  </div>
                </div>
                
                <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-blue-800">
                    <strong>Important:</strong> Always verify current local regulations before purchasing. 
                    Requirements vary significantly by jurisdiction and can change frequently.
                  </p>
                </div>
              </div>
            </div>
          </div>
        );

        // Tax Benefits Section
        const TaxBenefitsSection = () => (
          <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-8">
            <div className="flex items-start gap-4">
              <div className="p-3 bg-white/20 rounded-lg">
                <div className="w-6 h-6"><Icons.Receipt /></div>
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold mb-4">Potential Tax Benefits & Strategies</h3>
                
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-semibold mb-2">Common Deductions</h4>
                    <ul className="space-y-1 text-sm text-white/90">
                      <li>• Mortgage interest payments</li>
                      <li>• Property taxes</li>
                      <li>• Operating expenses</li>
                      <li>• Depreciation (residential: 27.5 years)</li>
                      <li>• Repairs and maintenance</li>
                      <li>• Property management fees</li>
                    </ul>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold mb-2">Advanced Strategies</h4>
                    <ul className="space-y-1 text-sm text-white/90">
                      <li>• Cost segregation studies</li>
                      <li>• 1031 exchanges for deferring capital gains</li>
                      <li>• Real estate professional status</li>
                      <li>• Opportunity zone investments</li>
                      <li>• Self-directed IRA/401k investing</li>
                    </ul>
                  </div>
                </div>
                
                <div className="mt-4 p-3 bg-white/10 rounded-lg">
                  <p className="text-sm">
                    <strong>Disclaimer:</strong> This is general information only. Consult with a qualified tax professional 
                    for advice specific to your situation.
                  </p>
                </div>
              </div>
            </div>
          </div>
        );

        // Data Sources Section
        const DataSourcesSection = () => (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div className="flex items-start gap-4">
              <div className="p-3 bg-blue-100 rounded-lg">
                <div className="w-6 h-6 text-blue-600"><Icons.Info /></div>
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Data Sources & Methodology</h3>
                
                <div className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Market Data Sources</h4>
                    <ul className="space-y-1 text-sm text-gray-600">
                      <li>• MLS comparable sales data</li>
                      <li>• Zillow/Redfin market estimates</li>
                      <li>• Local tax assessor records</li>
                      <li>• Rentometer rental comparables</li>
                      <li>• AirDNA short-term rental analytics</li>
                    </ul>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Analysis Methodology</h4>
                    <p className="text-sm text-gray-600">
                      Our AI analyzes real-time market data, comparable properties, and local rental trends 
                      to provide accurate estimates. Property taxes are based on local mill rates, insurance 
                      estimates use regional averages, and maintenance reserves follow industry standards 
                      (1-2% of property value annually).
                    </p>
                  </div>
                  
                  <div className="text-xs text-gray-500 mt-4">
                    Analysis generated: {new Date(propertyData.analysis_timestamp || Date.now()).toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

        // Cost Breakdown Modal
        const CostBreakdownModal = () => (
          <div className="modal-overlay" onClick={() => setShowCostModal(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-gray-900">Annual Cost Breakdown</h3>
                <button onClick={() => setShowCostModal(false)} className="text-gray-400 hover:text-gray-600">
                  <div className="w-6 h-6"><Icons.X /></div>
                </button>
              </div>
              
              <div className="space-y-4">
                {costBreakdown.map((item, index) => (
                  <div key={index} className="border-b border-gray-100 pb-4 last:border-0">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-3">
                        <div className="w-4 h-4 rounded" style={{ backgroundColor: item.color }}></div>
                        <h4 className="font-semibold text-gray-900">{item.name}</h4>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-gray-900">{formatCurrency(item.value)}</p>
                        <p className="text-sm text-gray-500">{formatCurrency(item.monthly)}/mo</p>
                      </div>
                    </div>
                    <p className="text-sm text-gray-600 ml-7">
                      {((item.value / totalAnnualCosts) * 100).toFixed(1)}% of total costs
                    </p>
                  </div>
                ))}
                
                <div className="pt-4 border-t-2 border-gray-200">
                  <div className="flex justify-between items-center">
                    <h4 className="font-bold text-gray-900">Total Annual Costs</h4>
                    <div className="text-right">
                      <p className="text-xl font-bold text-gray-900">{formatCurrency(totalAnnualCosts)}</p>
                      <p className="text-sm text-gray-500">{formatCurrency(totalAnnualCosts / 12)}/mo</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="mb-8 flex items-center justify-between flex-wrap gap-4">
                <div>
                  <h1 className="text-3xl font-bold text-gray-900">Property Investment Analysis</h1>
                  <div className="flex items-center gap-4 mt-2 flex-wrap">
                    <div className="flex items-center text-gray-600">
                      <div className="w-4 h-4 mr-1"><Icons.MapPin /></div>
                      <span className="text-sm">{propertyData.property_address || propertyData.property_details?.address}</span>
                    </div>
                    <div className="flex items-center text-gray-600">
                      <div className="w-4 h-4 mr-1"><Icons.Calendar /></div>
                      <span className="text-sm">{new Date(propertyData.analysis_timestamp || Date.now()).toLocaleDateString()}</span>
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => {
                    setCurrentView('dashboard');
                    setAnalysisData(null);
                  }}
                  className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-300"
                >
                  ← Back to Dashboard
                </button>
              </div>

              {/* Key Metrics */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <MetricCard
                  icon={Icons.Home}
                  title="Property Value"
                  value={formatCurrency(propertyData.property_details.estimated_value)}
                  subtitle={propertyData.property_details.property_type}
                />
                <MetricCard
                  icon={Icons.DollarSign}
                  title="Total Annual Costs"
                  value={formatCurrency(totalAnnualCosts)}
                  subtitle="All expenses included"
                />
                <MetricCard
                  icon={Icons.TrendingUp}
                  title="Best ROI"
                  value={`${propertyData.roi_percentage}%`}
                  subtitle="Recommended strategy"
                  trend="up"
                  trendValue={propertyData.roi_percentage}
                />
                <MetricCard
                  icon={Icons.DollarSign}
                  title="Max Annual Profit"
                  value={formatCurrency(Math.max(propertyData.short_term_rental.annual_profit, propertyData.long_term_rental.annual_profit))}
                  subtitle="Best case scenario"
                />
              </div>

              {/* Mortgage Calculator */}
              <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-gray-900">Mortgage Payment Calculator</h3>
                  {!showMortgageInput ? (
                    <button
                      onClick={() => setShowMortgageInput(true)}
                      className="text-blue-600 hover:text-blue-800 text-sm font-semibold"
                    >
                      Add Mortgage
                    </button>
                  ) : (
                    <button
                      onClick={() => {
                        setShowMortgageInput(false);
                        setMonthlyMortgage(0);
                      }}
                      className="text-gray-600 hover:text-gray-800 text-sm"
                    >
                      Clear
                    </button>
                  )}
                </div>
                
                {showMortgageInput && (
                  <div className="flex gap-4 items-end">
                    <div className="flex-1">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Monthly Mortgage Payment
                      </label>
                      <input
                        ref={mortgageInputRef}
                        type="number"
                        placeholder="Enter monthly payment"
                        className="mortgage-input"
                        value={monthlyMortgage || ''}
                        onChange={(e) => setMonthlyMortgage(parseFloat(e.target.value) || 0)}
                      />
                    </div>
                    <button
                      onClick={() => setShowMortgageInput(false)}
                      className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold"
                    >
                      Apply
                    </button>
                  </div>
                )}
                
                {monthlyMortgage > 0 && !showMortgageInput && (
                  <div className="bg-gray-50 rounded-lg p-4">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-700">Monthly Mortgage Payment</span>
                      <span className="font-bold text-gray-900">{formatCurrency(monthlyMortgage)}</span>
                    </div>
                  </div>
                )}
              </div>

              {/* Licensing Requirements */}
              <LicensingSection />

              {/* Rental Income Comparison */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <RentalIncomeCard type="short" data={propertyData.short_term_rental} />
                <RentalIncomeCard type="long" data={propertyData.long_term_rental} />
              </div>

              {/* Cost Breakdown with Interactive Pie Chart */}
              <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 className="text-xl font-bold text-gray-900 mb-4">Cost Breakdown</h2>
                <p className="text-sm text-gray-600 mb-4">Click on the chart or legend items for detailed breakdown</p>
                <InteractivePieChart />
              </div>

              {/* Tax Benefits */}
              <TaxBenefitsSection />

              {/* Data Sources */}
              <DataSourcesSection />

              {/* Recommendation */}
              <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div className="flex items-start gap-4">
                  <div className="p-3 bg-white/20 rounded-lg">
                    <div className="w-6 h-6"><Icons.AlertCircle /></div>
                  </div>
                  <div>
                    <h3 className="text-xl font-bold mb-2">Investment Recommendation</h3>
                    <p className="text-white/90">{propertyData.recommendation}</p>
                    <div className="mt-4 flex gap-4 flex-wrap">
                      <div className="flex items-center gap-2">
                        <div className="w-5 h-5"><Icons.Check /></div>
                        <span className="text-sm">AI-Powered Analysis</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-5 h-5"><Icons.Check /></div>
                        <span className="text-sm">Real-Time Market Data</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-5 h-5"><Icons.Check /></div>
                        <span className="text-sm">Comprehensive ROI Calculation</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Modals */}
              {showCostModal && <CostBreakdownModal />}
            </div>
          </div>
        );
      };

      // Main render logic
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <p className="text-red-600">{error}</p>
              <a href="index.html" className="mt-4 text-blue-600 hover:text-blue-800">
                Back to Homepage
              </a>
            </div>
          </div>
        );
      }

      switch (currentView) {
        case 'auth':
          return <AuthScreen />;
        case 'dashboard':
          return <Dashboard />;
        case 'processing':
          return <ProcessingScreen />;
        case 'results':
          return <InvestmentDashboard propertyData={analysisData} />;
        default:
          return <AuthScreen />;
      }
    };

    // Render the app
    try {
      const container = document.getElementById('root');
      if (container) {
        const root = ReactDOM.createRoot(container);
        root.render(<ROIFinderApp />);
      } else {
        console.error('Root element not found');
      }
    } catch (error) {
      console.error('Error rendering app:', error);
      document.getElementById('root').innerHTML = `
        <div style="padding: 40px; text-align: center; font-family: sans-serif;">
          <h2 style="color: #dc2626;">Error Loading Application</h2>
          <p style="color: #6b7280; margin: 20px 0;">${error.message}</p>
          <a href="index.html" style="color: #16a34a; text-decoration: none; font-weight: bold;">
            ← Back to Homepage
          </a>
        </div>
      `;
    }
  </script>
</body>
</html>
