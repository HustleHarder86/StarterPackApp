<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Investment Analysis - StarterPackApp</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <!-- Design System -->
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/property-confirmation-card.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- Content will be dynamically inserted here -->
    <div id="app-container"></div>

    <!-- Property Confirmation Component -->
    <script type="module" src="components/PropertyConfirmation.js"></script>
    
    <!-- Property Analysis API -->
    <script type="module" src="js/modules/property-analysis-api.js"></script>
    
    <!-- Firebase Config -->
    <script type="module" src="js/config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Import PropertyConfirmation component  
        import { PropertyConfirmation } from './components/PropertyConfirmation.js';

        class PropertyAnalysisApp {
            constructor() {
                this.propertyData = null;
                this.userData = null;
                this.analysisType = 'both';
                this.init();
            }

            async init() {
                // Initialize Firebase
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyDGpSf2IFHIERmW6A2FHoAaLa7rO3SjLpo",
                        authDomain: "investorprops-8c0a4.firebaseapp.com",
                        projectId: "investorprops-8c0a4",
                        storageBucket: "investorprops-8c0a4.appspot.com",
                        messagingSenderId: "1059899963221",
                        appId: "1:1059899963221:web:ba3e73b7bb5e9d6e3af41f"
                    };
                    
                    this.app = initializeApp(firebaseConfig);
                    this.auth = getAuth(this.app);
                    this.db = getFirestore(this.app);
                    console.log('[Property Analysis] Firebase initialized');
                } catch (error) {
                    console.warn('[Property Analysis] Firebase initialization failed:', error);
                }
                
                // Get property data from URL parameters
                this.extractPropertyDataFromURL();
                
                // Load user data
                await this.loadUserData();
                
                // Show property confirmation screen
                this.showPropertyConfirmation();
            }

            extractPropertyDataFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const propertyDataParam = urlParams.get('propertyData');
                const fromExtension = urlParams.get('fromExtension') === 'true';
                
                if (propertyDataParam) {
                    try {
                        this.propertyData = JSON.parse(decodeURIComponent(propertyDataParam));
                        console.log('[Property Analysis] Property data extracted:', this.propertyData);
                        
                        // Mark as from extension if applicable
                        if (fromExtension) {
                            this.propertyData.source = 'extension';
                        }
                    } catch (error) {
                        console.error('[Property Analysis] Error parsing property data:', error);
                        this.showError('Invalid property data provided');
                        return;
                    }
                } else {
                    // No property data - show manual input form or redirect
                    this.showManualInput();
                    return;
                }
            }

            async loadUserData() {
                try {
                    if (!this.auth) {
                        // No auth available, use anonymous data
                        this.userData = {
                            strTrialUsed: 0,
                            subscriptionTier: 'free'
                        };
                        return;
                    }
                    
                    return new Promise((resolve) => {
                        this.auth.onAuthStateChanged(async (user) => {
                            if (user && this.db) {
                                // Load user data from Firestore
                                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                                
                                try {
                                    const userDoc = await getDoc(doc(this.db, 'users', user.uid));
                                    if (userDoc.exists()) {
                                        this.userData = { uid: user.uid, ...userDoc.data() };
                                        console.log('[Property Analysis] User data loaded:', this.userData);
                                    } else {
                                        // Create basic user data
                                        this.userData = {
                                            uid: user.uid,
                                            email: user.email,
                                            strTrialUsed: 0,
                                            subscriptionTier: 'free'
                                        };
                                    }
                                } catch (error) {
                                    console.error('[Property Analysis] Error loading user data:', error);
                                    this.userData = {
                                        uid: user.uid,
                                        email: user.email,
                                        strTrialUsed: 0,
                                        subscriptionTier: 'free'
                                    };
                                }
                            } else {
                                // Anonymous user - use basic trial data
                                this.userData = {
                                    strTrialUsed: 0,
                                    subscriptionTier: 'free'
                                };
                                console.log('[Property Analysis] Anonymous user');
                            }
                            resolve();
                        });
                    });
                } catch (error) {
                    console.error('[Property Analysis] Error initializing auth:', error);
                    this.userData = {
                        strTrialUsed: 0,
                        subscriptionTier: 'free'
                    };
                }
            }

            showPropertyConfirmation() {
                if (!this.propertyData) {
                    this.showError('No property data available');
                    return;
                }

                // Create property confirmation component
                const confirmation = PropertyConfirmation(
                    this.propertyData,
                    (analysisType) => this.handleConfirm(analysisType),
                    () => this.handleCancel()
                );

                // Insert HTML
                document.getElementById('app-container').innerHTML = confirmation.html;

                // Setup component
                confirmation.setup(this.userData);
            }

            handleConfirm(analysisType) {
                this.analysisType = analysisType;
                console.log('[Property Analysis] Analysis confirmed with type:', analysisType);
                
                // Redirect to property analysis dashboard with the selected analysis type
                const dashboardUrl = new URL('./property-analysis-dashboard.html', window.location.origin);
                dashboardUrl.searchParams.set('propertyData', encodeURIComponent(JSON.stringify(this.propertyData)));
                dashboardUrl.searchParams.set('analysisType', analysisType);
                
                if (this.propertyData.source === 'extension') {
                    dashboardUrl.searchParams.set('fromExtension', 'true');
                }
                
                window.location.href = dashboardUrl.toString();
            }

            handleCancel() {
                console.log('[Property Analysis] Analysis cancelled');
                
                // If from extension, close the tab
                if (this.propertyData && this.propertyData.source === 'extension') {
                    window.close();
                } else {
                    // Redirect to main app
                    window.location.href = './roi-finder.html';
                }
            }

            showManualInput() {
                // Redirect to main app for manual input
                window.location.href = './roi-finder.html';
            }

            showError(message) {
                document.getElementById('app-container').innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    ">
                        <div style="
                            background: white;
                            border-radius: 12px;
                            padding: 40px;
                            text-align: center;
                            max-width: 400px;
                            width: 100%;
                            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                        ">
                            <h1 style="
                                color: #1a1a1a;
                                font-size: 24px;
                                font-weight: 700;
                                margin-bottom: 16px;
                            ">Oops!</h1>
                            <p style="
                                color: #666;
                                font-size: 16px;
                                margin-bottom: 24px;
                            ">${message}</p>
                            <button onclick="window.location.href='./roi-finder.html'" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                            ">Go to Dashboard</button>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new PropertyAnalysisApp();
        });
    </script>
</body>
</html>