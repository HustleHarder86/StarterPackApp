<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradient Local Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../styles/design-system.css">
    <link rel="stylesheet" href="../styles/gradient-theme.css">
    <style>
        /* Debug styles to ensure gradient visibility */
        #test-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 9999;
        }
        
        .test-button {
            margin: 5px;
            padding: 10px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .test-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Animated gradient background -->
    <div id="animated-bg">
        <div class="gradient-mesh"></div>
        <div class="orb w-96 h-96 gradient-primary floating" style="top: -10%; left: -10%;"></div>
        <div class="orb w-64 h-64 gradient-warning floating-delayed" style="top: 60%; right: -5%;"></div>
        <div class="orb w-80 h-80 gradient-success floating" style="bottom: -15%; left: 50%;"></div>
    </div>

    <!-- Main content -->
    <div class="container mx-auto p-6 relative z-10">
        <div class="glass-card p-6 mb-6">
            <h1 class="text-3xl font-bold mb-4 text-gradient">Gradient Persistence Test</h1>
            <p class="mb-6">This test simulates the full user flow to verify gradient background persists.</p>
            
            <div class="flex flex-wrap gap-4 mb-6">
                <button class="test-button" onclick="testInitialState()">1. Test Initial State</button>
                <button class="test-button" onclick="testLoadingState()">2. Show Loading State</button>
                <button class="test-button" onclick="testAnalysisResults()">3. Show Analysis Results</button>
                <button class="test-button" onclick="resetTest()">Reset</button>
            </div>
        </div>

        <!-- Test containers -->
        <div id="initial-state" class="glass-card p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Initial State</h2>
            <p>Property input form would be here...</p>
        </div>

        <div id="loading-state" class="hidden"></div>
        <div id="analysis-results" class="hidden"></div>
    </div>

    <!-- Test log -->
    <div id="test-log"></div>

    <script type="module">
        import { componentLoader } from '../js/modules/componentLoader.js';
        import { AnalysisLoadingState } from '../components/ui/AnalysisLoadingState.js';
        
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const checkGradientVisibility = () => {
            const animatedBg = document.getElementById('animated-bg');
            const computed = window.getComputedStyle(animatedBg);
            
            const checks = {
                display: computed.display,
                visibility: computed.visibility,
                opacity: computed.opacity,
                background: computed.background.substring(0, 50) + '...',
                zIndex: computed.zIndex
            };
            
            const isVisible = computed.display !== 'none' && 
                            computed.visibility !== 'hidden' && 
                            parseFloat(computed.opacity) > 0;
            
            log(`Gradient visibility: ${isVisible ? 'VISIBLE' : 'HIDDEN'}`, isVisible ? 'success' : 'error');
            log(`Details: ${JSON.stringify(checks, null, 2)}`);
            
            return isVisible;
        };

        window.testInitialState = () => {
            log('Testing initial state...');
            document.getElementById('initial-state').classList.remove('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('analysis-results').classList.add('hidden');
            checkGradientVisibility();
        };

        window.testLoadingState = () => {
            log('Testing loading state...');
            document.getElementById('initial-state').classList.add('hidden');
            document.getElementById('analysis-results').classList.add('hidden');
            
            const loadingContainer = document.getElementById('loading-state');
            loadingContainer.classList.remove('hidden');
            
            const loadingState = new AnalysisLoadingState(loadingContainer);
            loadingState.render();
            
            setTimeout(() => {
                checkGradientVisibility();
            }, 100);
        };

        window.testAnalysisResults = async () => {
            log('Testing analysis results...');
            document.getElementById('initial-state').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            
            const resultsContainer = document.getElementById('analysis-results');
            resultsContainer.classList.remove('hidden');
            
            // Mock analysis data
            const mockData = {
                propertyData: {
                    address: "123 Test Street, Toronto, ON",
                    price: 899000,
                    bedrooms: 3,
                    bathrooms: 2,
                    sqft: 1800
                },
                costs: {
                    mortgage: 3500,
                    propertyTax: 500,
                    insurance: 200,
                    utilities: 250,
                    maintenance: 350,
                    total: 4800
                },
                longTermRental: {
                    monthlyRent: 3500,
                    yearlyIncome: 42000,
                    cashFlow: -1300,
                    capRate: 0.047
                },
                strAnalysis: {
                    averageNightlyRate: 180,
                    occupancyRate: 0.75,
                    monthlyRevenue: 4050,
                    yearlyRevenue: 48600
                },
                analysisType: 'both'
            };
            
            try {
                await componentLoader.renderAnalysisResults(mockData, 'analysis-results');
                setTimeout(() => {
                    checkGradientVisibility();
                    
                    // Check for blocking elements
                    const blockers = Array.from(document.querySelectorAll('*')).filter(el => {
                        const rect = el.getBoundingClientRect();
                        const computed = window.getComputedStyle(el);
                        return rect.width >= window.innerWidth * 0.9 && 
                               rect.height >= window.innerHeight * 0.9 &&
                               computed.backgroundColor !== 'rgba(0, 0, 0, 0)' &&
                               computed.backgroundColor !== 'transparent';
                    });
                    
                    if (blockers.length > 0) {
                        log(`Found ${blockers.length} blocking elements:`, 'error');
                        blockers.forEach(el => {
                            log(`- ${el.tagName}#${el.id || 'no-id'}.${el.className || 'no-class'}`);
                        });
                    } else {
                        log('No blocking elements found!', 'success');
                    }
                }, 500);
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        };

        window.resetTest = () => {
            log('Resetting test...');
            document.getElementById('initial-state').classList.remove('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('loading-state').innerHTML = '';
            document.getElementById('analysis-results').classList.add('hidden');
            document.getElementById('analysis-results').innerHTML = '';
            checkGradientVisibility();
        };

        // Initial check
        log('Test page loaded');
        checkGradientVisibility();
    </script>
</body>
</html>